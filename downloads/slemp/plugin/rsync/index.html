<style>
.bt-w-menu {
	float: left;
	background-color: #f0f0f1;
	height: 100%;
	width: 110px
}

.bt-w-menu p {
	cursor: pointer;
	height: 40px;
	line-height: 40px;
	padding-left: 20px;
	position: relative;
	text-overflow: ellipsis;
	overflow: hidden
}

.bt-w-menu p a {
	display: block;
	text-decoration: none;
}

.bt-w-menu p .spanmove {
	display: none
}
.bt-w-con .serverSide,
.bt-w-con .clientSide,
.bt-w-con .logsSide{
	margin: 0 20px;
}
.serverSide_header,
.clientSide_header{
	padding-top:20px;
	overflow: hidden;
}
.serverSide_header .switch span{
	font-size: 14px;
}
.ssh-item{
	display: inline-block;
	height: 20px;
	line-height: 32px;
	float: none;
	margin: 0 10px;
}
.serverSide_header  .pull-right button{
	margin-right: 10px;
}
.serverSide .conter,
.clientSide .conter{
	margin-top: 20px;
}
.serverSide .divtable,
.clientSide .divtable{
	height: 450px;
	overflow-y: auto;
}
.psShow{
	cursor: pointer;
}
.pullDown{
	position: relative;
	padding: 5px 0;
}
.pullDown:hover ul{
	display: block !important;
}
.pullDown ul{
	position: absolute;
	right: -7px;
	top: 27px;
	z-index: 999;
	width: 45px;
	text-align: center;
	background: #fff;
	border: 1px solid #ececec;
}
.pullDown ul li{
	padding: 4px 0;
}
.pullDown ul:after{
	content: '';
	width: 10px;
	height: 10px;
	position: absolute;
	top: -6px;
	left: 19px;
	background: #fff;
	transform: rotate(45deg);
	border-top: 1px solid #ececec;
	border-left: 1px solid #ececec;
}
.wafConf{
	overflow: hidden;
	margin:15px;
}
.wafConf fieldset {
	border: 1px solid #ccc;
	border-radius: 3px;
	float: left;
	padding-bottom: 0;
	width: 370px
}

.wafConf fieldset:nth-of-type(2) {
	margin: 0px;
	margin-left:15px;
}

.wafConf legend {
	border: 0 none;
	font-size: 14px;
	margin: 0 6px;
	padding: 3px;
	width: auto
}

.wafConf fieldset input {
	margin-left: 4px
}

.wafConf fieldset .table {
	margin-top: -1px;
	margin-bottom: 0
}

.wafConf fieldset .table tr td:nth-of-type(2) {
	width: 42px
}

.wafConf fieldset .table-overflow {
	overflow: auto;
	margin-top: 10px;
	border-top: #ddd 1px solid
}

.wafConf-btn {
	border-bottom: #ddd 1px solid;
	margin-bottom: 12px;
	padding-bottom: 15px;
	height: 45px
}

.wafConf-btn span {
	float: left;
	margin-right: 8px;
	line-height: 33px
}

.wafConf-btn .btn {
	margin-right: 10px
}

.wafConf-btn .ssh-item {
	margin-right: 50px
}
.wafConf .table>tbody>tr:last-child{
	border-bottom: #ddd 1px solid;
}
.help-info-text li{
	list-style-type: decimal;
}
.bt-monitor .line{
	/*overflow: ;*/
	height: 44px;
}
.plan_hms{
	height: 30px;
}
.plan_hms span{
	height: 28px;
	line-height: 28px;
}
.plan_hms input{
	height: 30px;
}
.plan_hms span input{
	height: 27px;
}
code{
	padding: 1px 5px;
    font-size: 90%;
    color: #2196F3;
    background-color: #EEE;
    border-radius: 4px;
    margin: 2px;
}
.demo-class .line{
	padding-left: 35px;
}
.demo-class .bt-form{
	margin-top:10px;
}
.global-class .line{
	padding: 9px 0;
}
.clientSide .pull-left .btn{
	margin-right: 5px;
}
.help-info-text{
	margin-left: 10px;
}
.rsync_set_ip{
	width: 250px;
	display: inline-block;
}
.rsync_tip{
	display: inline-block;
	width: 200px;
	height: 100px;
	vertical-align: top;
	line-height: 25px;
	padding-left: 10px;
	padding-top: 8px;
}
</style>

<div class="tsynsList" style="display: none;">
	<div class="bt-w-menu">
		<p class="bgw"><a href="javascript:;" onclick="tsync.getClientInfo();">Send configuration</a></p>
		<p><a href="javascript:;" onclick="tsync.getServerInfo();">Receiving configuration</a></p>
	</div>
	<div class="bt-w-con" style="height: 558px;">
		<div class="clientSide" >
			<div class="clientSide_header">
				<div class="pull-left">
					<button class="btn btn-success btn-sm va0" onclick="tsync.setClientView(false)">Create a send task</button>
					<button class="btn btn-success btn-sm va0" onclick="tsync.setClientLocal()">Create local sync</button>
					<button class="btn btn-default btn-sm va0" onclick="tsync.methodLogs('lsyncd_logs')">Real-time log</button>
				</div>
			</div>
			<div class="conter divtable">
				<table class="table table-hover">
					<thead>
						<tr><th>Name (identification)</th><th>Source directory</th><th>Sync to</th><th width="40">Mode</th><th>Cycle</th><th style="text-align: right;" width="190">Action</th></tr>
					</thead>
					<tbody class="sideList"></tbody>
				</table>
			</div>
		</div>
		<div class="serverSide" style="display: none;">
			<div class="serverSide_header">
        <div class="pull-left">
        	<button class="btn btn-success btn-sm va0" onclick="tsync.setServerView(false)" style="margin-right: 6px;">Create a receiving task</button>
					<button class="btn btn-default btn-sm va0" onclick="tsync.setOverallView()">Global configuration</button>
				</div>
				<div class="switch pull-right">
					<span class="switchText"></span>
					<div class="ssh-item">
						<input class="btswitch btswitch-ios" id="switch" type="checkbox" onclick="tsync.serverSwitch()">
						<label class="btswitch-btn" for="switch"></label>
					</div>
				</div>
			</div>
			<div class="conter divtable">
				<table class="table table-hover">
					<thead>
						<tr><th>Username</th><th width="120">Password</th><th>Directory</th><th width="200">Remarks</th><th style= "text-align: right;">Action</th></tr>
					</thead>
					<tbody class="sideList"></tbody>
				</table>
			</div>
		</div>
		<div class="logsSide" style="display: none;padding-top: 20px;">
			<div class="conter divtable">
				<table class="table table-hover">
					<thead>
						<tr><th >Details</th><th style="text-align: right;">Operation time</th></tr>
					</thead>
					<tbody class="logsList"></tbody>
				</table>
				<div class="page"></div>
			</div>
		</div>
	</div>
</div>
<script type="javascript/text">
	var tsync = {
		setStatus:false,
		setTitle:'Add directory',
		setSubmit:'Submit',
		set_layer_View:'',
		cancelLog:'',
		setServerForm:{
			mName:'',
			path:'/opt/slemp/wwwroot/',
			passwd:'',
			comment:''
		},
		globals:{
			port:'',
			ip:''
		},
		setClientForm:{
			args:'',
			cron_info:{
				where_hour:'',
				id:'',
				type:'',
				where1:'1',
				where_minute:'1'
			},
			inotify_info:true,
			secret_key:'',
			ip:'',
			mName:'',
			path:'/opt/slemp/wwwroot/',
			exclude:'',
			include:''
		},
		initial:function(){
			var width = 1000;
			var height = 600;
			var _this = this;
			var boxwidth =  ($(document).width() / 2) - (width / 2);
			var boxheight =  ($(document).height() / 2) - (height / 2);
			$('.layui-layer-page').width(width);
			$('.layui-layer-page').height(height);
			$('.bt-w-menu').height((height - 1) - $('.layui-layer-title').height())
			$('.layui-layer-page').css({'left': boxwidth + 'px','top': boxheight +'px'});
			//$('.layui-layer-page').css({'left': boxwidth + 'px'});
			$(".bt-w-menu p").click(function(){
				var index = $(this).index();
				$(this).addClass("bgw").siblings().removeClass("bgw");
				$('.bt-w-con>div:eq('+ index +')').show().siblings().hide();
				$('.tip').show();
			});
			$('.tsynsList').show();
			this.getClientInfo();
		},
		get_logs:function(p){
			if(p == undefined) p = 1;
			var loadget =  layer.msg('Getting operation log...',{icon:16,time:0,shade: [0.3, '#000']});
			$.get('/plugin?action=a&name=rsync&s=get_logs&tojs=tsync.get_logs&p='+p,function(res){
				layer.close(loadget);
				var tbody = '';
				for(var i=0;i<res.data.length;i++){
					tbody += '<tr><td>'+res.data[i].log+'</td><td style="text-align: right;">'+res.data[i].addtime+'</td></tr>'
				}
				$(".logsList").html(tbody);
				$(".page").html(res.page);
			});
		},
		getServerInfo:function(){
			var _this = this;
			var loadget =  layer.msg('Getting configuration information...',{icon:16,time:0,shade: [0.3, '#000']});
			$.get('/plugin?action=a&name=rsync&s=get_global_conf',function(res){
				layer.close(loadget);
				if (res.open){
					$('#switch').attr('checked',res.open);
					$('.switchText').empty().append('<span style="color:#20a53a">Service is on</span>');
					$('.restart').show();
				}else{
					$('#switch').attr('checked',res.open);
					$('.switchText').empty().append('<span style="color:red">Service is closed</span>');
					$('.restart').hide();
				}
				var domData = '';
				for (var i = 0; i < res['modules'].length; i++) {
					domData += '<tr>\
									<td>'+ res['modules'][i].name +'</td>\
									<td width="120" style="position: relative;">\
										<span class="password" data-pw="'+ res['modules'][i].password + '">******</span>\
										<span class="glyphicon glyphicon-eye-open psShow" title="Show password" style="margin-left:5px"></span>\
									</td>\
									<td><a href="javascript:;" onclick="openPath(\''+ res['modules'][i].path+'\')" class="btlink">'+ res['modules'][i].path +'</a></td>\
									<td>'+ res['modules'][i].comment +'</td>\
									<td style="text-align: right;">\
										<a href="javascript:;" class="btlink generateKey" data-mName="'+res['modules'][i].name +'">Key</a> | \
										<a href="javascript:;" class="btlink" onclick="tsync.setServerView(\''+ res['modules'][i].name +'\')">Edit</a> | \
										<a href="javascript:;" style="color:red" onclick="tsync.delServerInfo(\''+ res['modules'][i].name +'\')">Delete</a>\
									</td>\
								</tr>'
				}
				$('.serverSide .sideList').empty().append(domData);
				$('.psShow').click(function(event) {
					if ($(this).hasClass('glyphicon-eye-open')) {
						$(this).removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');
						$(this).prev().text($(this).prev().attr('data-pw'));
					}else{
						$(this).removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');
						$(this).prev().text('******');
					}
				});
				$('.generateKey').click(function(event) {
					$.post('/plugin?action=a&name=rsync&s=get_secretkey',{mName:$(this).attr('data-mName')},function(res){
						this.set_layer_View = layer.open({
							type: 1,
							area: '500px',
							title: 'Receiving key',
							closeBtn: 2,
							shift: 0,
							shadeClose: false,
							content: "<div style='margin:30px;'><textarea class='form-control' rows='6' readonly='readonly'>"+ res +"</textarea></div>"
							});
					});
				});
				$('body').on('click', '.btcopy', function(event) {
					event.preventDefault();
					btcopy();
				});
			});
		},

		setServerView:function(mName){
			$.post('/plugin?action=a&name=rsync&s=get_module',{mName:mName},function(rdata){
				var _this = this,readonly = '';
				var status = true;
				if(!mName) {
					status = false;
					mName = '';
				}
				this.setStatus = status;
				if (status){
					this.setTitle = 'Edit reception';
					this.setSubmit = 'Save';
					readonly = 'readonly="readonly" disabled="disabled"'
					action = 'modify_module';
				}else{
					this.setTitle = 'Create receive';
					this.setSubmit = 'Submit';
					action = 'add_module'
					this.setServerForm = {
						mName:'',
						path:'/opt/slemp/wwwroot/',
						dont_commpress:'',
						password:RandomStrPwd(12),
						comment:''
					}
					rdata = this.setServerForm;
				}
				tsync.set_layer_View = layer.open({
					type: 1,
					area: '500px',
					title: _this.setTitle,
					closeBtn: 2,
					shift: 0,
					shadeClose: false,
					content: "<form class='bt-form pd20 pb70' id='fromServerPath' accept-charset='utf-8' enctype='application/x-www-form-urlencoded'>\
								<div class='line'>\
									<span class='tname'>Username</span>\
									<div class='info-r c4'>\
										<input class='bt-input-text' type='text' name='mName' "+ readonly +"  placeholder='Please fill in the username, no special symbols' value='"+ mName +"' style='width:300px' />\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>Password</span>\
									<div class='info-r c4'>\
										<input class='bt-input-text' type='text' name='password' placeholder='Please enter your password' value='"+ rdata.password +"' style='width:300px' />\
										<span title='Random code' style='margin-right: 10px;' class='glyphicon glyphicon-repeat cursor pws'></span>\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>Sync to</span>\
									<div class='info-r c4'>\
										<input id='inputPath' class='bt-input-text mr5' type='text' name='path' value='"+ rdata.path +"' placeholder='Please select a local path' style='width:300px' /><span class='glyphicon glyphicon-folder-open cursor' onclick='ChangePath(\"inputPath\")'></span>\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>Remarks</span>\
									<div class='info-r c4'>\
										<input class='bt-input-text' type='text' name='comment' placeholder='' value='"+ rdata.comment +"' style='width:300px' />\
									</div>\
								</div>\
								<div class='bt-form-submit-btn'>\
									<button type='button' class='btn btn-danger btn-sm btn-title colseView' onclick='layer.close(tsync.set_layer_View)'>Cancel</button>\
									<button type='button' class='btn btn-success btn-sm btn-title setViewData'>"+ _this.setSubmit +"</button>\
								</div>\
							  </form>",
					});
				$('.setViewData').click(function(event) {
					_this.setServerForm = {
						mName: $("input[name='mName']").val(),
						password: $("input[name='password']").val(),
						path: $("input[name='path']").val(),
						comment: $("input[name='comment']").val()
					}
					for(var index in _this.setServerForm){
						if (_this.setServerForm['mName'] == ''){
							layer.msg('Please enter the current username!');
							return false;
						}
						if (_this.setServerForm['password'] == ''){
							layer.msg('Please enter the current username and password!');
							return false;
						}
						if (_this.setServerForm['path'] == ''){
							layer.msg('Please enter the current sync directory!');
							return false;
						}
					}
					var loadget =  layer.msg('Submitting form information, please wait...',{icon:16,time:0,shade: [0.3, '#000']});
					$.post('/plugin?action=a&name=rsync&s=' + action,_this.setServerForm,function(res){
						layer.close(loadget);
						if (res.status){
	                    	layer.close(tsync.set_layer_View);
	                        tsync.getServerInfo();
							layer.msg(res.msg,{icon:1});
						}else{
							layer.msg(res.msg,{icon:2});
						}
					});
				});
				$('.pws').click(function(event) {
					$('input[name="password"]').val(RandomStrPwd(12));
				});
			});
		},

		setOverallView:function(){
			$.get('/plugin?action=a&name=rsync&s=get_global_conf',function(rdata){
				tsync.set_layer_View = layer.open({
					type: 1,
					skin: 'global-class',
					area: '600px',
					title: 'Rsync server global configuration',
					closeBtn: 2,
					shift: 0,
					shadeClose: false,
					content: "<form class='bt-form pd20 pb70' id='fromServerPath' >\
								<div class='line'>\
									<span class='tname'>Listening port</span>\
									<div class='info-r c4'>\
										<input style='width:60px;background-color: #f1f1f1;margin-right:5px;' class='bt-input-text' type='number' name='port' readonly value='"+ rdata.global['port'] +"' />\
										<span>Please leave this port in the firewall and security group, otherwise the sender will not be able to connect.</span>\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>Maximum number of connections</span>\
									<div class='info-r c4'>\
										<input style='width:60px;margin-right:5px;' class='bt-input-text' type='number' name='max_connections' value='"+ rdata.global['max connections'] +"' />\
										<span>Please set a reasonable maximum number of connections. If it is too high, it will increase the server load. If it is too low, it will affect the synchronization efficiency.</span>\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>Overtime</span>\
									<div class='info-r c4'>\
										<input style='width:60px;margin-right:5px;' class='bt-input-text' type='number' name='timeout' value='"+ rdata.global['timeout'] +"' />\
										<span>Seconds, depending on the file settings you want to synchronize, it is recommended to set between 300-1800</span>\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>Uncompressed file</span>\
									<div class='info-r c4'>\
										<input style='width:360px;margin-right:5px;' class='bt-input-text' type='text' name='dont_compress' value='"+ rdata.global['dont compress'] +"' />\
										<span>Each separated by a space</span>\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>IP whitelist</span>\
									<div class='info-r c4'>\
										<div class='rsync_set_ip'><textarea class='bt-input-text' rows='3' style='width:250px;height:100px;line-height: 20px;' name='hosts_allow' placeholder='Add an IP address per line&#10;Use Enter to split the IP address, for example:&#10;192.168.1.1&#10;127.0.0.1'>"+ rdata.global['hosts allow'].replace(/ /g,"\n") +"</textarea></div>\
										<div class='rsync_tip'>Only the machines in the IP whitelist are allowed to synchronize data with the server. One IP address per line. Leave blank if you do not have IP restrictions.</div>\
									</div>\
								</div>\
								<div class='bt-form-submit-btn'>\
									<button type='button' class='btn btn-danger btn-sm btn-title colseView' onclick='layer.close(tsync.set_layer_View)'>Cancel</button>\
									<button type='button' class='btn btn-success btn-sm btn-title setViewData'>Submit</button>\
								</div>\
							  </form>",
					});
				$('.setViewData').click(function(event) {
					var pdata = {
						hosts_allow:$("textarea[name='hosts_allow']").val(),
						max_connections:$("input[name='max_connections']").val(),
						dont_compress:$("input[name='dont_compress']").val(),
						timeout:$("input[name='timeout']").val()
					}
					var loadget =  layer.msg('Submitting form information, please wait...',{icon:16,time:0,shade: [0.3, '#000']});
					$.post('/plugin?action=a&name=rsync&s=modify_global_conf',pdata,function(res){
						layer.close(loadget);
						if (res.status){
							layer.msg(res.msg,{icon:1});
							layer.close(tsync.set_layer_View);
						}else{
							layer.msg(res.msg,{icon:2});
						}
					});
				});
			});
		},

		delServerInfo:function(mName){
			SafeMessage('Delete receive','Will you delete the reception ['+mName+'], are you sure?',function(){
				var loadT = layer.msg('Deleting receive ['+mName+'] <img src="/static/img/ing.gif">',{icon:16,time:0,shade: [0.3, "#000"]});
				$.post('/plugin?action=a&name=rsync&s=remove_module',{mName:mName},function(res){
					layer.close(loadT);
					layer.msg(res.msg,{icon:res.status?1:2});
					if (res.status) tsync.getServerInfo();
				});
			});
		},

		serverSwitch:function(switchs){
			var _this = this;
			var title = '';
			if (switchs == undefined){
				if ($('#switch').is(':checked')) {
					$('.switchText').empty().append('<span style="color:#20a53a">Service is on</span>');
					$('.restart').show();
					switchs = 'start';
					title = 'Opening service, please wait...';
				}else{
					$('.switchText').empty().append('<span style="color:red">Service is closed</span>');
					$('.restart').hide();
					switchs = 'stop';
					title = 'Shutting down the service, please wait...';
				}
			}else{
				$('.switchText').empty().append('<span style="color:#20a53a">Service is on</span>');
				switchs = 'start';
			}
			// layer.load();
			var loadget =  layer.msg(title,{icon:16,time:0,shade: [0.3, '#000']});
			$.post('/plugin?action=a&name=rsync&s=rsync_service',{state:switchs},function(res){
				layer.close(loadget);
				if (res.status){
					layer.msg(res.msg,{icon:1});
				}else{
					layer.msg(res.msg,{icon:2});
				}
			});
		},
		get_cycle:function(cron){
			var cycle_str = '';
			if(cron['type'] == 'minute-n'){
				cycle_str = 'every ' + cron['where1'] + ' minute';
			}else{
				cycle_str = 'every day ' + cron['hour'] + ' hour '+cron['minute']+' minute';
			}
			return cycle_str;
		},

		getClientInfo:function(){
			var _this = this,domData = '';
			var loadget =  layer.msg('Getting configuration information...',{icon:16,time:0,shade: [0.3, '#000']});
			$.get('/plugin?action=a&name=rsync&s=get_send_conf',function(res){
				layer.close(loadget);
				if(res.status === false){
					layer.closeAll();
					layer.msg(res.msg,{icon:2})
					return;
				}
				for(var i=0;i<res.length;i++){
				var to = 'Receiving server:'+res[i].ip+'::'+res[i].name.replace(/(\d+\.){3,3}\d+_/,'');
				var edits = 'tsync.setClientView(\''+ res[i].name +'\','+i+')';
				if(res[i].model == 'default.direct'){
					to = '<a href="javascript:;" onclick="openPath(\''+ res[i].to+'\')" class="btlink">Local:'+ res[i].to +'</a>';
					edits = 'tsync.setClientLocal(\''+ res[i].name +'\',\''+ res[i].path +'\',\''+ res[i].to +'\','+i+')';
				}
				domData += '<tr>\
						<td>'+ res[i].name +'</td>\
						<td><a href="javascript:;" onclick="openPath(\''+ res[i].path+'\')" class="btlink">'+ res[i].path +'</a></td>\
						<td>'+ to +'</td>\
						<td>'+ (res[i].delete == 'true'?'Complete':'Increment') +'</td>\
						<td>'+(res[i].realtime?'Real time':tsync.get_cycle(res[i].cron))+'</td>\
						<td style="text-align: right;">\
							<a href="javascript:;" class="btlink" title="Synchronize now" onclick="tsync.exec_cmd(\''+ res[i].name +'\')">Synchronize</a> | \
							<a href="javascript:;" class="btlink" title="View sync log" onclick="tsync.methodLogs(\''+ res[i].name +'\')">Log</a> | \
							<a href="javascript:;" class="btlink" onclick="tsync.blackWhiteList(\''+ res[i].name +'\')">Filter</a> | \
							<a href="javascript:;" class="btlink" onclick="'+edits+'">Edit</a> | \
							<a href="javascript:;" class="btlink" style="color:red" onclick="tsync.delClientInfo(\''+ res[i].name +'\')">Delete</a>\
						</td>\
					</tr>';
				}
				$('.clientSide .sideList').empty().append(domData);
				$('.psShow').click(function(event) {
					if ($(this).hasClass('glyphicon-eye-open')) {
						$(this).removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');
						$(this).prev().text($(this).prev().attr('data-pw'));
					}else{
						$(this).removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');
						$(this).prev().text('******');
					}
				});
			});
		},
		exec_cmd:function(name){
			var loadget =  layer.msg('Sending sync command...',{icon:16,time:0,shade: [0.3, '#000']});
			$.post('/plugin?action=a&name=rsync&s=exec_cmd',{mName:name},function(res){
				layer.close(loadget);
				layer.msg(res.msg,{icon:res.status?1:2});
			});
		},
		setClientLocal:function(name,path,to,index){
			if (name == undefined) name = '';
			if (path == undefined) path = '';
			if (to == undefined) to = '';
			this.set_layer_View = layer.open({
				type: 1,
				area: '500px',
				title: 'Local folder synchronization task',
				closeBtn: 2,
				shift: 0,
				shadeClose: false,
				content: "<form class='bt-form pd20 pb70' id='fromServerPath' accept-charset='utf-8'>\
							<div class='line'>\
								<span class='tname'>Name</span>\
								<div class='info-r c4'>\
									<input class='bt-input-text' type='text' name='mName' placeholder='Please fill in the name, no special symbols' value='"+name+"' style='width:300px;"+(name==''?'':'background-color:#f1f1f1;')+"' "+(name==''?'':'readonly')+" />\
								</div>\
							</div>\
							<div class='line'>\
								<span class='tname'>From</span>\
								<div class='info-r c4'>\
									<input id='inputPath' class='bt-input-text mr5' type='text' name='path' value='"+path+"' placeholder='Please select the folder to be synced' style='width:300px' /><span class='glyphicon glyphicon-folder-open cursor' onclick='ChangePath(\"inputPath\")'></span>\
								</div>\
							</div>\
							<div class='line'>\
								<span class='tname'>Sync to</span>\
								<div class='info-r c4'>\
									<input id='inputPath2' class='bt-input-text mr5' type='text' name='path' value='"+to+"' placeholder='Please select the destination folder' style='width:300px' /><span class='glyphicon glyphicon-folder-open cursor' onclick='ChangePath(\"inputPath2\")'></span>\
								</div>\
							</div>\
							<div class='bt-form-submit-btn'>\
								<button type='button' class='btn btn-danger btn-sm btn-title colseView' onclick='layer.close(tsync.set_layer_View)'>Cancel</button>\
								<button type='button' class='btn btn-success btn-sm btn-title' onclick='tsync.add_local_sync("+index+")'>"+(name==''?'Add to':'Save')+"</button>\
							</div>\
							<ul class=\"help-info-text c7\">\
								<li>[Sync Directory]: If not ending with <code>/</code>, it means that the data is synchronized to the secondary directory</li>\
								<li>[Note]: Here is the synchronization of the internal directory of the server. After adding the two directories, it will be synchronized in real time!</li>\
							  </ul>\
						  </form>",
				});
		},
		add_local_sync:function(index){
			var pdata = {
				mName:$("input[name='mName']").val(),
				path:$("#inputPath").val(),
				to:$("#inputPath2").val(),
				model:'default.direct',
				index:index
			}

			if(pdata['nName'] == '' || pdata['path'] == '' || pdata['to'] == ''){
				layer.msg('Please fill in the task name, the folder being synchronized, the target folder!');
				return;
			}
			var loading = layer.msg('Submit the data, please wait...',{icon:16,time:0,shade: [0.3, '#000']});
			$.post('/plugin?action=a&name=rsync&s=add_ormodify_send',pdata,function(rdata){
				layer.close(loading);
				layer.msg(rdata.msg,{icon:rdata.status?1:2});
				if(rdata.status){
					layer.close(tsync.set_layer_View)
					tsync.getClientInfo();
				}
			});
		},

		setClientView:function(mName,index){
			var loadget =  layer.msg('Getting configuration information...',{icon:16,time:0,shade: [0.3, '#000']});
			$.post('/plugin?action=a&name=rsync&s=get_send_byname',{mName:mName},function(rdata){
				layer.close(loadget);
				var _this = this,aulv = '',alwv = '',real ='',timing='',day = '',min='',none='',hour='',minuten='';
				var status = (mName == false)?false:true;
				console.log(status)
				this.setStatus = status;
				if (status){
					this.setTitle = 'Edit synchronization task';
					this.setSubmit = 'Save';
					this.setClientForm = rdata;
					if (this.setClientForm.delete != 'true'){
						aulv = 'selected ="selected "';
					}else{
						alwv = 'selected ="selected "';
					}
					if (this.setClientForm.realtime) {
						real = 'selected ="selected "';
						none = 'display:none;';
					}else{
						timing ='selected ="selected "';
						none = 'display:block;';
					}
					if (this.setClientForm.cron.type == 'day'){
						day = 'selected ="selected "';
						hour = 'display:block;';
						minuten = 'display:none;';
					}else{
						min ='selected ="selected "';
						hour = 'display:none;';
						minuten = 'display:block;';
					}
				}else{
					this.setTitle = 'Create a send task';
					this.setSubmit = 'Submit';
					none = 'display:none;';
					minuten = 'display:none;';
					this.setClientForm = {
						delete:'false',
						cron:{
							where_hour:'0',
							id:'',
							type:'',
							where1:'1',
							where_minute:'0'
						},
						rsync:{
							bwlimit:1024
						},
						delay:3,
						realtime:true,
						secret_key:'',
						ip:'',
						mName:'',
						path:'/opt/slemp/wwwroot/',
						exclude:'',
					}
				}
				tsync.set_layer_View = layer.open({
					type: 1,
					skin: 'demo-class',
					area: '600px',
					title: _this.setTitle,
					closeBtn: 2,
					shift: 0,
					shadeClose: false,
					content: "<form class='bt-form pd20 pb70 ' id='fromServerPath' accept-charset='utf-8'>\
								<div class='line'>\
									<span class='tname'>Server IP</span>\
									<div class='info-r c4'>\
										<input class='bt-input-text' type='text' name='ip' placeholder='Please enter the receiving server IP' value='"+ _this.setClientForm.ip +"' style='width:310px' />\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>Synchronize directory</span>\
									<div class='info-r c4'>\
										<input id='inputPath' class='bt-input-text mr5' type='text' name='path' value='"+ _this.setClientForm.path +"' placeholder='Please select a sync directory' style='width:310px' /><span class='glyphicon glyphicon-folder-open cursor' onclick='ChangePath(\"inputPath\")'></span>\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>Synchronously</span>\
									<div class='info-r c4'>\
										<select class='bt-input-text' name='delete' style='width:100px'>\
											<option value='false' "+ aulv +">Increment</option>\
											<option value='true' "+ alwv +">Complete</option>\
										</select>\
										<span style='margin-left: 20px;margin-right: 10px;'>Synchronization cycle</span>\
										<select class='bt-input-text synchronization' name='realtime' style='width:100px'>\
											<option value='true' "+ real +">Real-time synchronization</option>\
											<option value='false' "+ timing +">Timing synchronization</option>\
										</select>\
									</div>\
								</div>\
								<!--<div class='line'>\
									<span class='tname'>Synchronization cycle</span>\
									<div class='info-r c4'>\
										<select class='bt-input-text synchronization' name='realtime' style='width:100px'>\
											<option value='true' "+ real +">Real-time synchronization</option>\
											<option value='false' "+ timing +">Timing synchronization</option>\
										</select>\
									</div>\
								</div>-->\
								<div class='line' id='period' style='"+ none +"height:45px;'>\
									<span class='tname'>Timing period</span>\
									<div class='info-r c4'>\
										<select class='bt-input-text pull-left mr20' name='period' style='width:100px;'>\
											<option value='day' "+ day +">Every day</option>\
											<option value='minute-n' "+ min +">N minutes</option>\
										</select>\
										<div class='plan_hms pull-left mr20 bt-input-text hour' style='"+ hour +"'>\
											<span><input type='number' name='hour' value='"+ _this.setClientForm.cron.hour +"' maxlength='2' max='23' min='0'></span>\
											<span class='name'>Hour</span>\
										</div>\
										<div class='plan_hms pull-left mr20 bt-input-text minute' style='"+ hour +"'>\
											<span><input type='number' name='minute' value='"+ _this.setClientForm.cron.minute +"' maxlength='2' max='59' min='0'></span>\
											<span class='name'>Minute</span>\
										</div>\
										<div class='plan_hms pull-left mr20 bt-input-text minute-n' style='"+ minuten +"'>\
											<span><input type='number' name='minute-n' value='"+ _this.setClientForm.cron.where1 +"' maxlength='2' max='59' min='0'></span>\
											<span class='name'>Minute</span>\
										</div>\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>Speed limit</span>\
									<div class='info-r c4'>\
										<input class='bt-input-text' type='number' name='bwlimit' min='0'  value='"+ _this.setClientForm.rsync.bwlimit +"' style='width:100px' /> KB\
										<span style='margin-left: 54px;margin-right: 10px;'>Delay</span><input class='bt-input-text' min='0' type='number' name='delay'  value='"+ _this.setClientForm.delay +"' style='width:100px' /> 秒\
									</div>\
								</div>\
								<div class='line'>\
									<span class='tname'>Receiving key</span>\
									<div class='info-r c4'>\
										<textarea id='mainDomain' class='bt-input-text' name='secret_key' style='width:310px;height:75px;line-height:22px' placeholder='This key is the key to receive the configuration [receive account]'>"+ _this.setClientForm.secret_key +"</textarea>\
									</div>\
								</div>\
								<div class='bt-form-submit-btn'>\
									<button type='button' class='btn btn-danger btn-sm btn-title colseView' onclick='layer.close(tsync.set_layer_View)'>Cancel</button>\
									<button type='button' class='btn btn-success btn-sm btn-title setViewData'>"+ _this.setSubmit +"</button>\
								</div>\
								<ul class=\"help-info-text c7\">\
									<li>[Sync directory]: If you do not end with <code>/</code>, it means that the data is synchronized to the secondary directory. In general, the directory path ends with <code>/</code></li>\
								  	<li>[Synchronous mode] Increment: Synchronize when data is changed/added, and only append and replace files</li>\
								  	<li>[Synchronization mode] Complete: Keep the data at both ends consistent with the directory structure, and delete, append and replace files and directories synchronously.</li>\
								  	<li>[Speed Limit]: Limit the speed of data synchronization tasks to prevent bandwidth from running up due to synchronous data.</li>\
								  	<li>[Delay]: Only the asynchronous recording is recorded during the delay time period, and the data is synchronized once after the arrival period to save the overhead.</li>\
								  </ul>\
							  </form>",
					});
				$('.synchronization').click(function(event) {
					var selVal = $('.synchronization option:selected').val();
					if (selVal == "false"){
						$('#period').show();
					}else{
						$('#period').hide();
						$('.hour input,.minute input').val('0');
						$('.minute-n input').val('1');
					}
				});
				$('#period select').click(function(event) {
					var selVal = $('#period select option:selected').val();
					if (selVal == 'day'){
						$('.hour,.minute').show();
						if ($('.hour input').val() == ''){
							$('.hour input,.minute input').val('0');
						}
						$('.minute-n').hide();
					}else{
						$('.hour,.minute').hide();
						$('.minute-n').show();
						if ($('.minute-n input').val() == ''){
							$('.minute-n input').val('1');
						}
					}
				});
				$('.setViewData').click(function(event) {
					var server = {
						ip:'',
						path:'',
						secret_key:'',
						delete:'true',
						realtime:'true',
						cron:{
							type:'',
							where1:'',
							hour:'',
							minute:'',
							id:'',
						}
					}
					if ($('input[name="ip"]').val() != ''){
						server.ip = $('input[name="ip"]').val();
					}else{
						layer.msg('Please enter the server IP address!');
						return false;
					}
					if($('input[name="bwlimit"]').val() > -1){
						server.bwlimit = $('input[name="bwlimit"]').val();
					}

					if($('input[name="delay"]').val() > -1){
						server.delay = $('input[name="delay"]').val();
					}

					if ($('input[name="path"]').val() != ''){
						server.path = $('input[name="path"]').val();
					}else{
						layer.msg('Please enter the sync directory!');
						return false;
					}
					server.delete = $('select[name="delete"] option:selected').val();
					server.realtime = ($('select[name="realtime"] option:selected').val() == 'true'?true:false);
					if (!server.realtime) {
						server.cron.type = $('select[name="period"] option:selected').val();
						if (server.cron.type == 'day') {
							server.cron.hour = $('input[name="hour"]').val();
							server.cron.minute = $('input[name="minute"]').val();
							if (server.cron.hour == '' || server.cron.minute =='') {
								layer.msg('Please enter the sync time!');
								return false;
							}
						}else{
							server.cron.where1 = $('input[name="minute-n"]').val();
							if (server.cron.where1 == '') {
								layer.msg('Please enter the sync time!');
								return false;
							}
						}
					}
					if ( $('textarea[name="secret_key"]').val() != ''){
						server.secret_key = $('textarea[name="secret_key"]').val();
					}else{
						layer.msg('Please enter the receiving key!');
						return false;
					}

					server.cron = JSON.stringify(server.cron);
					server.index = index
					var loading = layer.msg('Submit the data, please wait...',{icon:16,time:0,shade: [0.3, '#000']});
					$.post('/plugin?action=a&name=rsync&s=add_ormodify_send',server,function(res){
						layer.close(loading);
						if (res.status){
							layer.close(tsync.set_layer_View);
							tsync.getClientInfo();
							setTimeout(function(){
								layer.msg(res.msg,{icon:1});
							},200)
						}else{
							layer.msg(res.msg,{icon:2});
						}

					});
					function method(){

					}
				});
			});
		},

		delClientInfo:function(mName){
			var _this = this;
			SafeMessage('Delete sync task','The sync task will be deleted soon['+mName+'], sure?',function(){
				var loadT = layer.msg('Deleting sync task ['+mName+'] <img src="/static/img/ing.gif">',{icon:16,time:0,shade: [0.3, "#000"]});
				$.post('/plugin?action=a&name=rsync&s=remove_send',{mName:mName},function(res){
					layer.close(loadT);
					if (res.status){
						layer.msg(res.msg,{icon:1});
						_this.getClientInfo();
					}else{
						layer.msg(res.msg,{icon:2});
					}
				});
			});
		},

		methodLogs:function(mName){
			tsync.set_layer_View = layer.msg('Getting synchronization log',{icon:16,time:0,shade: [0.3, '#000']});
			$.post('/plugin?action=a&name=rsync&s=get_rsync_logs',{mName:mName}, function(res) {
				layer.close(tsync.set_layer_View);
				tsync.cancelLog = layer.open({
					type:1,
					title:'View sync log ['+mName+']',
					area: ['1000px','540px'],
					shadeClose:false,
					closeBtn:2,
					content:'<div class="setchmod bt-form pd20 pb70">'
							+'<pre style="overflow: auto; border: 0px none; padding: 15px; margin: 0px; height: 410px; background-color: #333;color: #fff;" id ="preLogs">'+res.msg+'</pre>'
							+'<div class="bt-form-submit-btn" style="margin-top: 0px;">'
							+'<button type="button" class="btn btn-success btn-sm btn-delLogs" style="margin-right:10px;">Empty</button>'
							+'<button type=white"button" class="btn btn-danger btn-sm" onclick="layer.close(tsync.cancelLog)">Cancel</button>'
						    +'</div>'
							+'</div>'
				});
				setTimeout(function(){
					var ob = document.getElementById('preLogs');
					ob.scrollTop = ob.scrollHeight;
				},300);
				$('.btn-delLogs').click(function(event) {
					layer.confirm('Confirm delete '+ mName +', sure？',{title:'Delete log',icon:3},function(){
						$.post('/plugin?action=a&name=rsync&s=remove_rsync_logs',{mName:mName}, function(res) {
							if (res.status){
								$('#preLogs').html('');
								layer.msg(res.msg,{icon:1});
							}else{
								layer.msg(res.msg,{icon:2});
							}
						});
					});
				});
			});
		},

		blackWhiteList:function(name){
			var _this = this;
				layer.open({
					type:1,
					title:'Filter',
					area: '400px',
					shadeClose:false,
					closeBtn:2,
					content:'<div class="wafConf">\
								<div style="overflow:hidden;">\
									<fieldset>\
										<legend>Excluded files and directories</legend>\
										<input type="text" class="bt-input-text mr5" data-type="exclude" title="E.g: .log, .log, /\home/\www/\" placeholder="E.g: .log, test.log, /\home/\www/\" style="width:305px;">\
										<button data-type="exclude" class=" addList btn btn-default btn-sm">Add to</button>\
										<div class="table-overflow">\
											<table class="table table-hover BlockList"><tbody></tbody></table>\
										</div>\
									</fieldset>\
								</div>\
								<div>\
									<ul class="help-info-text c7" style="list-style-type:decimal;">\
										<li>Excluded files and directories are directories or files that do not need to be synchronized in the current directory.</li>\
										<li>If the rule starts with a slash <code>/</code>, it will match all from the beginning.</li>\
										<li>If the rule ends with <code>/</code>, to match the end of the monitoring path</li>\
										<li><code>?</code> Matches any character but does not include<code>/</code></li>\
										<li><code>*</code> Match 0 or more characters but not including<code>/</code></li>\
										<li><code>**</code> Match 0 or more characters, can be <code>/</code></li>\
									</ul>\
								</div>\
							</div>'
				});
			function getIncludeExclude(mName){
				loadT = layer.msg('Getting data...',{icon:16,time:0,shade: [0.3, '#000']});
				$.post('/plugin?action=a&name=rsync&s=get_exclude', {mName:mName}, function(res) {
					layer.close(loadT);
					var list=''
					for (var i = 0; i < res.length; i++) {
						list += '<tr><td>'+ res[i] +'</td><td><a href="javascript:;" data-type='+ mName +' class="delList">Delete</a></td></tr>';
					}
					$('.wafConf .BlockList tbody').empty().append(list);
				});
			}
			getIncludeExclude(name);
			function addArgs(mName,exclude){
				console.log(mName + ',' + exclude)
				loadT = layer.msg('Adding...',{icon:16,time:0,shade: [0.3, '#000']});
				$.post('/plugin?action=a&name=rsync&s=add_exclude', {mName:mName,exclude:exclude}, function(res){
					layer.close(loadT);
					if (res.status){
						getIncludeExclude(mName);
						$('.wafConf input').val('');
						layer.msg(res.msg);
					}else{
						layer.msg(res.msg);
					}
				});
			}
			$('.addList').click(function(event) {
				var val = $(this).prev().val();
				if(val == ''){
					layer.msg('The current input is empty, please enter');
					return false;
				}
				addArgs(name,val);
			});
			$('.wafConf input').keyup(function(event){
				if (event.which == 13){
					var val = $(this).val();
					if(val == ''){
						layer.msg('The current input is empty, please enter');
						return false;
					}
					addArgs(name,val);
				}
			});
			$('.wafConf').on('click', '.delList', function(event) {
				var val = $(this).parent().prev().text();
				loadT = layer.msg('Deleting...',{icon:16,time:0,shade: [0.3, '#000']});
				$.post('/plugin?action=a&name=rsync&s=remove_exclude', {mName:name,exclude:val}, function(res){
					layer.close(loadT)
					if (res.status){
						getIncludeExclude(name);
						layer.msg(res.msg);
					}else{
						layer.msg(res.msg);
					}
				});
			});
		}
	}
	tsync.initial();
</script>
