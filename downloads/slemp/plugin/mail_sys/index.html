<style type="text/css">
	.tasklist {
		padding: 0;
	}

	.tab-con {
		margin-left: 15px;
	}

	.tab-con .SetupPostfix {
		overflow: hidden;
	}

	.tab-con .clearfixPostfix>p {
		float: left;
		margin-top: 35px;
		margin-left: 25px;
	}

	.tab-con .clearfixPostfix>p button {
		margin-right: 15px;
		padding-left: 18px;
		padding-right: 18px;
	}

	.tab-con .SetupPostfix .clearfixPostfix {
		overflow: hidden;
		margin-bottom: 25px;
	}

	.tab-con .SetupPostfix .SetAggregateOne p {
		margin-top: 15px;
	}

	.tab-con .SetupPostfix .SetAggregateOne p span {
		margin-right: 15px;
		display: inline-block;
		width: 51px;
		text-align: right;
	}

	.tab-con .SetupPostfix .SetAggregateOne p input {
		height: 30px;
		width: 240px;
		padding-left: 10px;
		font-size: 13px;
	}

	.tab-con .SetupPostfix .SetAggregateOne {
		width: 325px;
		float: left;
	}

	.tab-con .info-r .bt-input-text{
		width: 193px;
	}

	.tasklist .tab-nav {
		background-color: #F0F0F1;
		width: 125px;
		height: 750px;
		float: left;
		border-bottom: 0px;
	}

	.tasklist .tab-nav span {
		display: block;
		width: 125px;
		padding-right: 0;
		height: 40px;
		line-height: 40px;
		padding-left: 20px;
		position: relative;
		cursor: pointer;
		border: none;
		background: #F0F0F1;
	}
	.select_conter>input{
	    border: none !important;
	    width: 350px !important;
	    padding: 0 35px 0 10px !important;
	}
	.send_mail_conter input {
		width: 95%;
		border-radius: 0;
		box-shadow: 1px 1px 2px #ececec inset;
		outline: 0;
		padding: 0 10px;
		font-size: 14px;
        vertical-align: top;
        height: 34px;
	}
	.domain_table {
		height: 450px;
		overflow: auto;
	}
	.tasklist .tab-nav span.on {
		background-color: #fff;
	}

	.send_mail_conter .line {
		margin-bottom: 10px;
	}

	.send_mail_conter .line>span {
		width: 60px;
		height: 30px;
		line-height: 30px;
		margin-right: 10px;
		text-align: right;
		display: inline-block;
	}

	.send_mail_conter .line .conter {
		width: 90%;
		height: 30px;
		line-height: 30px;
		display: inline-block;

	}
	.send_mail_conter .select_conter{
        margin-left: 0;
        border: 1px solid #ccc;

    }
	.send_mail_conter .sender_list {
		margin-left: -3px;
		padding: 0 10px;
	}
	.send_mail_conter .line>span{
        height: 34px;
        line-height: 34px;
    }
    .send_mail_conter .line input{
        height: 34px;
        line-height: 34px;
    }

	.editor_conter {
		position: relative;
		height: 430px;
	}

	.editor_conter .sname {
		position: absolute;
		top: 0px;
	}
	.cke_editor_editor1{
		width: 95%;
	}

	.editor_conter .conter {
		position: absolute;
		left:73px;
		height: 100% !important;
	}

	.right {
		width: auto;
		height: auto;
		position: initial;
	}

	.radio_glign_ground {
		display: inline-block;
		height: 25px;
		line-height: 25px;
		vertical-align: top;
		margin-right: 15px;
		font-weight: 400;
		font-size: 14px;
	}

	.radio_glign {
		height: 15px;
		width: 15px;
		position: relative;
		top: 2px;
		margin-right: 5px !important;
	}

	.bt-form-login .line .tname {
		width: 110px;
	}

	#domain_list .btswitch+.btswitch-btn,
	#mailboxs_list .btswitch+.btswitch-btn {
		width: 2.4em;
		height: 1.4em;
		margin-bottom: 0
	}

	#Editor .w-e-toolbar,
	#Editor .w-e-text-container {
		width: 95%
	}

	.service_tip {
		display: inline-block;
		width: 100%;
		height: 35px;
		line-height: 35px;
		background: #F0F0F1;
		padding-right: 15px;
		text-align: right;
	}

	.mail_title {
		width: 100%;
		background: #ecf5ff;
		border-bottom: 1px solid #ececec;
		padding: 20px 45px;
	}

	.mail_title ul li {
		height: 20px;
		line-height: 20px;
		margin-bottom: 5px;
      	color:#888;
	}

	.mail_title ul h4 {
      	color:#333;
		font-size: 16px;
		font-weight: 600;
		padding-bottom: 7px;
      	border-bottom:1px solid #999;
	}

	.mail_conter {
		line-height: 25px;
		font-size: 13px;
		padding: 35px 45px;
	}

	.cke_editor_editor1 .cke_top {
		padding: 2px;
		height: 28px !important;
	}

	.mail_html {
		display: inline-block;
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
		vertical-align: bottom;
	}
	.mail_html span{
		color: #bbb;
	}

	input[readonly] {
		background-color: #efefef;
	}
	.selects_conter{
		position: relative;
		z-index: 999
	}
	.selects_conter .select_text{
		display: inline-block;
		height: 36px;
		line-height: 36px;
		padding:0 15px;
		position: relative;
		border: 1px solid #ececec;
		background: #f3f3f3;
		color: #666;
	}
	.select_conter{
		display: inline-block;
		font-size: 14px;
		border: 1px solid #ececec;
		color: #444;
		position: relative;
		cursor: pointer;
		height: 36px;
		line-height: 36px;
		margin-left: -5px;
		vertical-align: bottom;
	}
	.select_conter .domain_input,
	.select_conter .domain_inputs{
		display: inline-block;
		padding-left: 15px;
		height: 34px;
		line-height: 34px;
		vertical-align: top;
	}
	.inbox_input:focus{ outline: none;}
	.select_conter .select_down{
		display: inline-block;
		width: 0;
		height: 0;
		border-width: 6px;
		border-style: solid;
		border-color:#777 transparent transparent transparent;
		position: absolute;
		top: 14px;
		right: 12px;
		transition: all 500ms;
	}

	.select_conter .domain_list{
		display: none;
		background: #fff;
		position: absolute;
		top: 34px;
		left: -1px;
		border: 1px solid #ececec;
		overflow-y: auto;
        max-height: 280px;
        width: 203px;
        box-shadow: 2px 5px 8px #ccc;
	}
	.select_conter .domain_list.active{
		display: block;
	}
	.select_conter .domain_list li{
		text-align: left;
		padding: 0 15px;
	}
	.select_conter .domain_list li:hover{
		background: #20a53a;
		color: #fff;
	}
	.select_conter .domain_list li.active{
		background: #20a53a;
		color: #fff;
	}

	.bt_tips {
		font-size: 16px;
		color: #444;
		font-weight: 600;
		margin-bottom: 10px;
	}
	.bt_vice_tips{
		font-size: 14px;
		color: #666;
		margin-bottom: 10px;
	}
	.bt-body .bt_conter{
		margin-bottom: 30px;
	}
	.bt-body .bt_center{
		text-align: center;
		margin-bottom: 15px;
	}
	.mail_table{
		height: 460px;
    	overflow: auto;
		position: relative;
	}
	.bt_select{
		display: inline-block;
		width: auto;
		outline: none;
		border-radius: 0;
		height: 30px;
		line-height: 30px;
		padding: 0 10px;
		font-size: 13px;
	}
	.user_info .help-info-text b{
		color: #666;
	}
	.logs_code_style {
		margin: 0px;
		background-color: #333;
		color: #fff;
		padding: 0 5px;
		width: 100%;
		height: 635px;
		line-height: 20px;
	}
	.user_forward input,
	.user_forward select{
		width: 300px;
	}
	.tabs-nav {
		border-bottom: #cacad9 1px solid;
	}
	.tabs-nav .on {
		background: #fff;
		border-bottom: #fff 1px solid;
		color: #444;
	}
	.tabs-nav span {
		background-color: #ddd;
		background: -moz-linear-gradient(top, #f6f6f6, #ddd);
		background: -webkit-gradient(linear, 0% 0, 0% 100%, from(#f6f6f6), to(#ddd));
		background: -ms-linear-gradient(top, #f6f6f6, #ddd);
		height: 32px;
		line-height: 32px;
		padding: 0 12px;
		border: #cacad9 1px solid;
		color: #444;
		display: inline-block;
		margin: 0 3px -1px 0;
		cursor: pointer;
	}
	.mail_backup .plan .typename {
		width: 85px;
	}
	.mail_backup_set .plan_hms span input {
		width: 50px;
		padding-left: 5px;
	}
	.mail_backup_set .plan_hms{
		padding-left: 0;
	}
	.mail_backup .plan {
		margin-bottom: 0;
		padding-left: 0;
	}
	.mail_backup .line .tname{
		width: 105px;
	}
</style>
<div class="tasklist">
	<div class="tab-nav">
        <span class="on">Domain List</span>
		<span>BCC</span>
		<span>SMTP Relay</span>
		<span>Mail forward</span>
		<span>Mail backup</span>
		<span>Inbox</span>
		<span>Spam</span>
        <span>Outbox</span>
        <span>Send mail</span>
        <span>Service Status</span>
		<span>Log</span>
    </div>
    <div class="tab-con">
        <div class="task_block">
			<button class="btn btn-sm btn-success mb15" style="margin-right:10px;" onclick="mail.edit_domain_view(true)">Add Domain</button>
			<!-- <div class="ssl-item" style="display: flex;width: 150px;float: right;">
				<span style="display: inline-table;margin-top: 2px; margin-right: 5px;">Add Certificate</span>
				<input type="checkbox" id="certificateSSL" class="btswitch btswitch-ios">
				<label for="certificateSSL" class="btswitch-btn" onclick="mail.open_certificate_view()"></label>
			</div> -->
			<a href="https://doc.aapanel.com/web/#/3?page_id=178" target="blank" style="color:#20a53a;font-size: 13px;display: inline-block;margin-left: 15px;">[Help]</a>
			<button class="btn btn-sm btn-success mb15" style="float:right" id="flush_domain_record">Refresh domain record</button>
			<div class="ssl-item" style="display: flex;width: 111px;float: right;padding-top: 4px;margin-right: 20px;">
				<span style="display: inline-table;margin-top: 2px; margin-right: 5px;">Anti spam</span>
				<input type="checkbox" id="anti_spam" class="btswitch btswitch-ios">
				<label for="anti_spam" class="btswitch-btn" onclick="mail.turn_anti_spam()"></label>
			</div>
            <div class="domain_table divtable">
                <table class="table table-hover">
                    <thead>
                        <tr>
							<th>Domain</th>
                            <th>MX record</th>
                            <th>A record</th>
                            <th>SPF record</th>
                            <th>DKIM record</th>
                            <th>DMARC record</th>
                            <th>CatchALL</th>
                            <th width="205px" style="text-align: right;">Operating</th>
                        </tr>
                    </thead>
                    <tbody id="domain_list"></tbody>
				</table>
            </div>
			<div class="page" id="domain_page"></div>
            <ul class="help-info-text c7 mlr20">
                <li><font style="color:red">After adding a domain name, you need to add MX records (for mailbox services) and TXT records (for mailbox anti-spam services) in order to use the mailbox service normally.</font></li>
                <li><font style="color:red">Tip: Some cloud vendors will shut down port 25 by default. You need to contact the manufacturer to open port 25 to use the post office service</font></li>
                <li>The self-built post office version is the base version. It only provides basic functions. For more functions, please be patient and wait for the development progress.</li>
            </ul>
		</div>
		<div class="task_block" style="display:none;">
			<div class="t-mana">
				<button class="btn btn-sm btn-success add_bcc" style="margin-bottom: 10px;">Add BCC</button>
				<div class="tabs-nav" style="position: relative;">
					<span class="on">Recipient</span>
					<span>Sender</span>
				</div>
				<div class="text_con">
					<div class="text_block">
						<div class="forward_table divtable ptb15">
							<table class="table table-hover">
								<thead>
									<tr>
										<th style="width: 30%;">Need Copy</th>
										<th style="width: 30%;">Copy to</th>
										<th style="text-align: right;">Operating</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
							<div class="tbTbody" style="max-height: 562px;overflow: auto;">
								<table class="table table-hover">
									<thead></thead>
									<tbody id="recipient_list"></tbody>
								</table>
							</div>
							<!-- <div class="page" id="recipient_page"></div> -->
						</div>
					</div>
					<div class="text_block" style="display: none;">
						<div class="forward_table divtable ptb15">
							<table class="table table-hover">
								<thead>
									<tr>
										<th style="width: 30%;">Need Copy</th>
										<th style="width: 30%;">Copy to</th>
										<th style="text-align: right;">Operating</th>
									</tr>
								</thead>
								<tbody></tbody>
							</table>
							<div class="tbTbody" style="max-height: 562px;overflow: auto;">
								<table class="table table-hover">
									<thead></thead>
									<tbody id="sender_list"></tbody>
								</table>
							</div>
							<!-- <div class="page" id="sender_page"></div> -->
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="task_block" style="display:none;">
			<div class="line" style="border-bottom: 1px solid #ccc;margin-bottom: 10px;padding-left: 19px;">
				<span class="tname checkType" style="color:#20a53a;font-size: 14px;">SMTP Relay</span>
				<div style="display: inline-block;height: 32px;line-height: 32px;">
					<input type="checkbox" name="checksmtp" id="checksmtp" class="btswitch btswitch-ios">
					<label for="checksmtp" class="btswitch-btn" style="margin-top:5px;"></label>
				</div>
				<a href="https://forum.aapanel.com/d/1254-how-to-use-the-mail-server-relay-function" target="blank" style="color:#20a53a;font-size: 13px;display: inline-block;margin-left: 23px;height: 32px;line-height: 32px;overflow: hidden;text-decoration: none;">[HELP]</a>
			</div>
			<div class="smtp" style="display:none;">
				<div class="line">
					<span class="tname">Username</span>
					<div class="info-r">
						<input type="text" name="smtp_username" class="bt-input-text mr5" placeholder="SMTP Username">
					</div>
				</div>
				<div class="line">
					<span class="tname">Passwd</span>
					<div class="info-r">
						<input type="text" name="passwd" class="bt-input-text mr5" placeholder="SMTP Passwd">
					</div>
				</div>
				<div class="line">
					<span class="tname">Port</span>
					<div class="info-r">
						<input type="text" name="port" class="bt-input-text mr5" placeholder="SMTP Port">
					</div>
				</div>
				<div class="line">
					<span class="tname">Host</span>
					<div class="info-r">
						<input type="text" name="smtphost" class="bt-input-text mr5" placeholder="SMTP Host">
					</div>
				</div>
				<div style="margin: 17px 0 10px 124px;"><button class="btn btn-success btn-sm mb15 smtp_save">Save</button></div>
			</div>
		</div>
		<div class="task_block" style="display:none;">
			<div class="t-mana">
				<div>
					<button class="btn btn-success btn-sm ml5 add_forward">Add Forward</button>
				</div>
				<div class="text_con">
					<div class="text_block" style="display: block;">
						<div class="divtable mtb15" style="max-height: 635px;overflow: auto;">
							<table class="table table-hover" id="mail_forward_list">
								<thead>
									<tr>
										<th>Address</th>
										<th>Goto</th>
										<th>Domain</th>
										<th>Created</th>
										<th>Modified</th>
										<th>Status</th>
										<th>Option</th>
									</tr>
								</thead>
								<tbody class="mail_forward_list">

								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="task_block" style="display:none;padding: 0 10px;">
			<div class="mail_backup">
				<div class="line">
					<span class="tname checkType" style="color:#20a53a;font-size: 14px;text-align: left;">Backup Plan</span>
					<div style="display: inline-block;height: 32px;line-height: 32px;">
						<input type="checkbox" name="backup_task" id="backup_task" class="btswitch btswitch-ios">
						<label for="backup_task" class="btswitch-btn" style="margin-top:5px;"></label>
					</div>
				</div>
				<div class="mail_backup_set" style="border-top: 1px solid #ccc;padding-top: 10px;display: none;margin-bottom: 20px;">
					<div class="clearfix plan">
						<span class="typename c4 pull-left f14 text-right mr20">Period</span>
						<div class="dropdown plancycle pull-left mr20">
							<button class="btn btn-default dropdown-toggle" type="button" id="cycle"
								data-toggle="dropdown" style="width:94px">
								<b val="week">Weekly</b>
								<span class="caret"></span>
							</button>
							<ul class="dropdown-menu" role="menu" aria-labelledby="cycle">
								<li>
									<a role="menuitem" tabindex="-1" href="javascript:;" value="day">Daily</a>
								</li>
								<li>
									<a role="menuitem" tabindex="-1" href="javascript:;" value="week">Weekly</a>
								</li>
							</ul>
						</div>
						<div id="ptime" class="pull-left">
							<div class="dropdown planweek pull-left mr20">
								<button class="btn btn-default dropdown-toggle" type="button" id="excode" data-toggle="dropdown"  style="width:auto;">
									<b val="1">Monday</b> <span class="caret"></span>
								</button>
								<ul class="dropdown-menu" role="menu" aria-labelledby="excode">
									<li><a role="menuitem" tabindex="-1" href="javascript:;" value="1">Monday</a></li>
									<li><a role="menuitem" tabindex="-1" href="javascript:;" value="2">Tuesday</a></li>
									<li><a role="menuitem" tabindex="-1" href="javascript:;" value="3">Wednesday</a></li>
									<li><a role="menuitem" tabindex="-1" href="javascript:;" value="4">Thursday</a></li>
									<li><a role="menuitem" tabindex="-1" href="javascript:;" value="5">Friday</a></li>
									<li><a role="menuitem" tabindex="-1" href="javascript:;" value="6">Saturday</a></li>
									<li><a role="menuitem" tabindex="-1" href="javascript:;" value="0">Sunday</a></li>
								</ul>
							</div>
							<div class="plan_hms pull-left mr20 bt-input-text">
								<span><input type="number" name="hour" maxlength="2" max="23" min="0" value="1"></span>
								<span class="name">Hour</span>
							</div>
							<div class="plan_hms pull-left mr20 bt-input-text">
								<span><input type="number" name="minute" maxlength="2" max="59" min="0" value="30"></span>
								<span class="name">Minute</span>
							</div>
						</div>
					</div>
					<div class="clearfix plan" style="margin-bottom: 0;">
						<span class="typename controls c4 pull-left f14 text-right mr20">Backup to</span>
						<div id="backup_plan" style="line-height:34px">
							<div class="dropdown planBackupTo pull-left mr20" style="display:inline-block">
								<button class="btn btn-default dropdown-toggle" type="button" name="backupTo" data-toggle="dropdown" style="width:auto;">
									<b val="localhost">Disk of server</b> <span class="caret"></span>
								</button>
								<ul class="dropdown-menu" role="menu" aria-labelledby="excode"></ul>
							</div>
							<div class="textname pull-left mr20">Keep last</div>
							<div class="plan_hms pull-left mr20 bt-input-text">
								<span><input type="number" name="save" maxlength="4" max="100" min="1" value="3"></span>
								<span class="name"></span>
							</div>
							<p class="clearfix plan"> </p>
						</div>
					</div>
					<div><button class="btn btn-success btn-sm mb15 backup_save" style="margin-left: 105px;">Save</button>
					</div>
				</div>
			</div>
			<div class="line" style="border-top: 1px solid #ccc;padding-top: 13px;">
				<span class="tname checkType" style="color:#20a53a;font-size: 14px;width: 105px;color:#20a53a;font-size: 14px;width: 105px;text-align: left;">Mail import</span>
				<button class="btn btn-sm btn-default" style="margin-top: 2px;" onclick="mail.upload_files()">Upload from local</button>
				<div class="divtable mtb15" style="max-height:275px; overflow:auto;">
					<table id="mail_backup_list" class="table table-hover">
						<thead>
							<tr>
								<th>File name</th>
								<th>Import time</th>
								<th style="text-align:right;">Operation</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>cnarea20191031.sql</td>
								<td>2020/05/22 14:54:50</td>
								<td style="text-align:right"><a class="btlink" herf="javascrpit:;" onclick="bt.database.input_sql('/opt/slemp/backup/database/cnarea20191031.sql','web')">恢复</a>
									| <a class="btlink" onclick="database.remove_input_file('/opt/slemp/backup/database/cnarea20191031.sql','web')">删除</a>
								</td>
							</tr>
							<tr>
								<td>db_web_20200417_163412.sql.gz</td>
								<td>2020/04/17 16:34:20</td>
								<td style="text-align:right"><a class="btlink" herf="javascrpit:;" onclick="bt.database.input_sql('/opt/slemp/backup/database/db_web_20200417_163412.sql.gz','web')">恢复</a>
									| <a class="btlink" onclick="database.remove_input_file('/opt/slemp/backup/database/db_web_20200417_163412.sql.gz','web')">删除</a>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<ul class="help-info-text c7 mlr20 backup-path" style="margin-top: 0;">
				<li>
					<font style="color:red">1. Mail backup is invoking the panel [Cron Job], &nbsp;if want to execute it immediately, go to [Cron Job]-[Task List] execute the task named: [Do not delete] Mail server data backup task.</font>
				</li>
				<li>
					<font style="color:red">2. Local backups are stored in &nbsp;'<span>/backup_path</span>/path' &nbsp;directory, &nbsp;it can be directly used for recovery.</font>
				</li>
				<li><font style="color:red">3. Cloud backup needs to be downloaded locally, &nbsp;and then uploaded to the server directory &nbsp;'<span>/backup_path</span>/path'&nbsp; by clicking the [Upload from local] button, &nbsp;after that you can restore the backup.</font></li>
			</ul>
		</div>
        <div class="task_block divtable" style="display:none;">
			<div class="selects_conter" style="margin-bottom: 10px;">
				<span  class="select_text">Email Address</span>
				<div class="select_conter">
					<span style="display: none;" class="domain_hide_value"></span>
					<input type="text" placeholder="please choose" autocomplete="off" class="inbox_input domain_input" name="inbox_input" style="height: 30px;border: none;">
					<ul class="domain_list" id="domain_select_list"></ul>
					<!--<span class="select_down"></span>-->
				</div>
				<div style="display: inline-block;margin-left: 30px;">
					Mail retention time：
					<input type="text" placeholder="3" class="bt-input-text mr5 mail_day" style="width: 65px;"
						onkeyup="value=value.match(/^0|[1-9]{1}[0-9]*$/)">day
					<button class="btn btn-success btn-sm set_save_day" style="margin-left: 10px;">Save</button>
				</div>
			</div>

			<div class="mail_table">
				<table class="table table-hover" id="mailListTable">
					<thead>
						<tr>
							<th width="15%">Sender</th>
							<th>Theme</th>
							<th width="250">Time</th>
							<th width="150">Operating</th>
						</tr>
					</thead>
					<tbody id="mails_list"></tbody>
				</table>
			</div>
			<div class="page" id="mails_page"></div>
		</div>
		<div class="task_block divtable" style="height: 630px;display:none;">
			<div class="selects_conter" style="margin-bottom: 10px;">
				<span class="select_text">Email Address</span>
				<div class="select_conter">
					<span style="display: none;" class="domain_hide_value"></span>
					<input type="text" placeholder="please choose" autocomplete="off" class="inbox_input domain_input"
						name="inbox_input" style="border: none;">
        			<ul class="domain_list" >
        				<li><font style="color:red">Mail retention time: Set the expiration time of the outbox mail file will be cleared out, the default is [0] permanent storage.</font></li>
        			</ul>
			        <!--<span class="select_down"></span>-->
			     </div>
			 </div>
			<div class="junks_table" style="height:460px">
    			<table class="table table-hover" id="junksListTable">
    				<thead>
    					<tr>
    						<th width="15%">Sender</th>
    						<th>Theme</th>
    						<th width="250">Time</th>
    						<th width="150">Operating</th>
    					</tr>
    				</thead>
    				<tbody id="junks_list"></tbody>
    			</table>
    		</div>
    		<div class="page" id="junks_page"></div>
		</div>
		<div class="task_block divtable" style="display:none;">
			<div class="selects_conter" style="margin-bottom: 10px;">
				<span  class="select_text">Email Address</span>
				<div class="select_conter">
					<span style="display: none;" class="domain_hide_value"></span>
					<input type="text" placeholder="please choose" autocomplete="off" class="inbox_input domain_inputs" name="inboxs_input" style="height: 30px;border: none;">
					<ul class="domain_list" id="domain_select_lists"></ul>
					<!--<span class="select_down"></span>-->
				</div>
				<div style="display: inline-block;margin-left: 30px;">
					Mail retention time：
					<input type="text" placeholder="3" class="bt-input-text mr5 mail_day" style="width: 65px;"
						onkeyup="value=value.match(/^0|[1-9]{1}[0-9]*$/)">day
					<button class="btn btn-success btn-sm set_save_day" style="margin-left: 10px;">Save</button>
				</div>
			</div>
			<div class="mail_table">
				<table class="table table-hover" id="mailListTables">
					<thead>
						<tr>
							<th width="15%">Recipient</th>
							<th>Theme</th>
							<th width="250">Time</th>
							<th width="120">Operate</th>
						</tr>
					</thead>
					<tbody id="mails_lists"></tbody>
				</table>
			</div>
			<ul class="help-info-text c7 mlr20">
				<li><font style="color:red">Mail retention time: Set the expiration time of the outbox mail file will be cleared out, the default is [0] permanent storage.</font></li>
			</ul>
		</div>
		<div class="task_block send_mail_conter" style="display:none;">
			<div class="line">
                <span class="sname">Sender</span>
                <div class="select_conter">
                    <span style="display: none;" class="domain_hide_value"></span>
					<input type="text" placeholder="Please enter or select user email" autocomplete="off" class="inbox_input domain_input" name="send_input" style="border: none;vertical-align: top;height: 34px;">
					<ul class="domain_list" style="z-index: 2;"></ul>
					<!--<span class="select_down"></span>-->
				</div>
            </div>
            <div class="line"><span class="sname">Recipient</span>
                <div class="conter"><input type="text" name="mail_to" class="bt-input-text" placeholder="Multiple recipients use  ,  to separate recipient mailboxes"></div>
            </div>
            <div class="line"><span class="sname">Theme</span>
                <div class="conter"><input type="text" name="subject" class="bt-input-text"></div>
            </div>
            <div class="line editor_conter">
                <span class="sname">Text</span>
                <div class="conter">
                    <textarea name="editor1" id="editor1" rows="10" cols="80"></textarea>
                </div>
            </div>
            <div class="line">
                <span class="sname">&nbsp;</span>
				<div class="conter"><button class="btn btn-sm btn-success" style="margin-right: 10px;" onclick="mail.sublimt_send_mail_request()">Send</button>
					<button class="btn btn-sm btn-default"  onclick="mail.clear_send_mail()">Clear</button></div>
            </div>
            <ul class="help-info-text c7 mlr20">
            <li><font style="color:red">Tip: This feature is only recommended for testing the sending function. If you use it, please use the client software (such as foxmail) or api interface.</font></li>
            </ul>
        </div>
        <div class="task_block divtable" style="display:none;">
			<table class="table table-hover">
				<thead>
					<tr><th>Service Name</th><th>Service Status</th><th width="220" style="text-align: center">Operate</th></tr>
				</thead>
				<tbody>
					<tr>
						<td>Dovecot</td>
						<td><span class="dovecot">Getting...</span></td>
						<td style="text-align: right">
							<a href="javascript:" class="btlink dovecot_start" onclick="mail.service_admin('dovecot', 'start')">Start</a>
							<a href="javascript:" class="btlink dovecot_stop" onclick="mail.service_admin('dovecot', 'stop')">Stop</a>&nbsp;|&nbsp;
							<a href="javascript:" class="btlink" onclick="mail.service_admin('dovecot', 'restart')">Restart</a>&nbsp;|&nbsp;
							<a href="javascript:" class="btlink" onclick="mail.service_admin('dovecot', 'repair')">Repair</a>&nbsp;|&nbsp;
							<a href="javascript:;" class="btlink" onclick="mail.open_editCode_view({service:'dovecot',title:'dovecot_config_file'})">Config</a>
						</td>
					</tr>
					<tr>
						<td>Opendkim</td>
						<td><span class="opendkim">Getting...</span></td>
						<td style="text-align: right">
							<a href="javascript:" class="btlink opendkim_start" onclick="mail.service_admin('opendkim', 'start')">Start</a>
							<a href="javascript:" class="btlink opendkim_stop" onclick="mail.service_admin('opendkim', 'stop')">Stop</a>&nbsp;|&nbsp;
							<a href="javascript:" class="btlink" onclick="mail.service_admin('opendkim', 'restart')">Restart</a>&nbsp;|&nbsp;
							<a href="javascript:" class="btlink" onclick="mail.service_admin('opendkim', 'repair')">Repair</a>&nbsp;|&nbsp;
							<a href="javascript:;" class="btlink" onclick="mail.open_editCode_view({service:'opendkim',title:'opendkim_config_file'})">Config</a>
						</td>
					</tr>
					<tr>
						<td>Postfix</td>
						<td><span class="postfix">Getting...</span></td>
						<td style="text-align: right">
							<a href="javascript:" class="btlink postfix_start" onclick="mail.service_admin('postfix', 'start')">Start</a>
							<a href="javascript:" class="btlink postfix_stop" onclick="mail.service_admin('postfix', 'stop')">Stop</a>&nbsp;|&nbsp;
							<a href="javascript:" class="btlink" onclick="mail.service_admin('postfix', 'restart')">Restart</a>&nbsp;|&nbsp;
							<a href="javascript:" class="btlink" onclick="mail.service_admin('postfix', 'repair')">Repair</a>&nbsp;|&nbsp;
							<a href="javascript:;" class="btlink" onclick="mail.open_editCode_view({service:'postfix',title:'postfix_config_file'})">Config</a>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		<div class="task_block" style="display:none;">
			<textarea id="mail_logs_val" class="logs_code_style"></textarea>
		</div>
	</div>
</div>
<script type="text/javascript" src="/static/js/bt_upload.js?version=7.4.2"></script>
<script type="text/javascript">
	var mail = {
		plugin_name: 'mail_sys',
		_editor: '',
		_domain_name: '',
		active_username:'',
		mail_list: '',
		domain_list: '',
		mailboxs_list: '',
		mail_user_list:[],
		_server_hostname:'',
		forward_list: {
			recipient: [],
			sender: []
		},
		all_mail_data: [],
		mail_index: 0,
		is_mail:0,//邮局状态
		is_mail_backup: false,
		is_update:true,
		smtp_status: false,
		// 初始化
		init: function () {
			var _this = this;
			//$('.layui-layer-page').width('1000');
			$('.layui-layer-page').hide();
			setTimeout(function(){
			    var win = $(window),layer = $('.layui-layer-page');
			    layer.show();
			    layer.css({
			        'width':'1010px',
			        'top':((win.height()-layer.height())/2)+'px',
			        'left':((win.width()-1000)/2)+'px',
			        'zIndex':'999'
			    });
			    $('.layui-layer-shade').css('zIndex','998');
			},200);
			$('.tasklist .tab-nav span').click(function(){
				var index = $(this).index();
				$(this).addClass('on').siblings().removeClass('on');
				$('.tab-con .task_block').eq(index).show().siblings().hide();
				switch (index) {
					case 0:
						_this.create_domain_list();
						_this.get_mailSSL_status(function(res){
							$('#certificateSSL').prop("checked", res);
						});
						_this.get_anti_spam_status(function(res){
							$('#anti_spam').prop("checked", res);
						});
					break;
					case 1:
						_this.get_bcc_list();
					break;
					case 2:
						_this.get_smtp();
					break;
					case 3:
						_this.mail_forward();
					break;
					case 5:
						_this.create_mail_list();
						_this.is_mail = 0;
					break;
					case 6:
						_this.junk_mail_list();
						_this.is_mail = 1;
					break;
					case 7:
						_this.create_sent_mail_list();
						_this.is_mail = 2;
						break;
					case 8:
						_this.get_domains_html();
						_this.is_mail = 3;
						break;
					case 9:
						_this.get_service_status(function(res){
							for(var item in res){
								$('.'+item).html(res[item]?'<span style="color:#20a53a;">Running</span><span style="color:#20a53a" class="glyphicon glyphicon-play"></span>':'<span style="color:red;">Stop</span><span style="color:red" class="glyphicon glyphicon-pause"></span>');
								switch (item){
									case 'postfix':
										$(!res[item] ? '.postfix_start' : '.postfix_stop').show();
										$(res[item] ? '.postfix_start' : '.postfix_stop').hide();
										break;
									case 'dovecot':
										$(!res[item] ? '.dovecot_start' : '.dovecot_stop').show();
										$(res[item] ? '.dovecot_start' : '.dovecot_stop').hide();
										break;
									case 'opendkim':
										$(!res[item] ? '.opendkim_start' : '.opendkim_stop').show();
										$(res[item] ? '.opendkim_start' : '.opendkim_stop').hide();
										break;
								}
							}
						});
					break;
					case 10:
						_this.get_logs_list(function(res){
							$('#mail_logs_val').val(res.log);
							$('#mail_logs_val').scrollTop($('#mail_logs_val').prop("scrollHeight"),200);
						});
					break;
					case 4:
						_this.get_backup_task_status(function (res) {
							$('.mail_backup #backup_task').prop('checked', res.status);
							if (res.status){
								$('.mail_backup_set').show();
								_this.is_mail_backup = true;
								var oss = 'Disk of server';
								switch (res.msg.backupTo) {
									case 'localhost':
										oss = 'Disk of server'
										break;
									case 'gdrive':
										oss = 'Google Drive'
										break;
									case 'gcloud_storage':
										oss = 'Google Cloud Storage'
										break;
									case 'ftp':
										oss = 'FTP storage space'
										break;
									case 'aws_s3':
										oss = 'AWS S3 storage'
										break;
									default:
										break;
								}
								$('.mail_backup_set #cycle').find("b").text(res.msg.type == 'week' ? 'Weekly' : 'Daily').attr("val", res.msg.type);
								$(".mail_backup_set .plan_hms [name='hour']").val(res.msg.where_hour);
								$(".mail_backup_set .plan_hms [name='minute']").val(res.msg.where_minute);
								$(".mail_backup_set .plan_hms [name='save']").val(res.msg.save);
								$(".mail_backup_set .plan_hms [name='backupTo']").val(oss);
								if (res.msg.type == 'day') $('.planweek').hide();
							}else{
								$('.mail_backup_set').hide();
							}
							_this.get_backup_list();
							_this.get_cloud_storage_list(function (rdata) {
								var _ul = '<li><a role="menuitem" tabindex="-1" href="javascript:;" value="localhost">Disk of server</a></li>';
								for (var i = 0; i < rdata.length; i++) {
									_ul += '<li><a role="menuitem" tabindex="-1" href="javascript:;" value="'+rdata[i].value+'">'+rdata[i].name+'</a></li>'
								}
								$('#backup_plan ul').html(_ul);
							});
							bt.fixed_table('mail_backup_list');
							$('.backup-path span').text(getCookie('backup_path'));
						});
					break;
				}
			});
			$('.t-mana .tabs-nav span').click(function(){
				var index = $(this).index();
				$(this).addClass("on").siblings().removeClass("on");
				$('.text_con .text_block').eq(index).show().siblings().hide();
				switch(index){
					case 0:
						_this.recipient_view();
					break;
					case 1:
						_this.sender_view();
					break;
				}
			});

			$('#domain_list').on('click', '.open-switch-actives', function () {
				var checked = $(this).prop('checked');
				var index = $(this).attr('data-index');
				var _form = _this.domain_list[index];
				_this.update_domain({
					active: checked ? 1 : 0,
					domain: _form.domain,
					company_name: _form.company_name,
					admin_name: _form.admin_name,
					admin_phone: _form.admin_phone
				}, function (res) {
					layer.msg(res.msg, { icon: 1 });
				});
			});

			$('#checksmtp').change(function(){
				var type = $(this).prop('checked');
				if (!type) {
					_this.cancel_smtp_relay();
				}
				$('.smtp').css('display',type?'block':'none');
			});
			$('.smtp .smtp_save').click(function(){
				var setting={};
	        	setting['username'] = $(".smtp input[name='smtp_username']").val();
	        	setting['passwd'] = $(".smtp input[name='passwd']").val();
	        	setting['port'] = $(".smtp input[name='port']").val();
	        	setting['smtphost'] = $(".smtp input[name='smtphost']").val();
	        	_this.set_smtp_relay(setting,function (res) {
					_this.smtp_status = true;
	            	layer.msg(res.msg,{icon:res.status?1:2});
	    		});
			});

			$('#domain_list').on('click', '.del_domain', function () {
				var domain = $(this).attr('data-domain');
				layer.confirm("Whether to delete the [{1}] domain name".replace('{1}',domain), { icon: 0, closeBtn: 2, title: "Del domain" }, function (index) {
					_this.del_domain({
						domain: domain
					}, function (res) {
						_this.create_domain_list({ page: 1, size: 10 }, function () {
							layer.msg(res.msg, { icon: 1 });
						});
					});
				});
			});

			$('.t-mana').on('click', '.add_bcc', function () {
				layer.open({
					type: 1,
					title: 'Blind Carbon Copy',
					area: '550px',
					closeBtn: 2,
                    shift: 0,
                    btn:['Confirm','Cancel'],
					content: '<div class="user_forward">\
							<div class="bt-form pd20">\
								<div class="line">\
									<span class="tname">Type</span>\
									<div class="info-r c4">\
										<select name="forward_type" class="bt-input-text">\
											<option value="sender">BCC when sending</option>\
											<option value="recipient">BCC when receiving</option>\
										</select>\
									</div>\
								</div>\
								<div class="line">\
									<span class="tname">Need Copy</span>\
									<div class="info-r c4">\
										<input class="bt-input-text mr5" type="text" name="forward_user" value="" placeholder="Enter the users you need to Bcc">\
									</div>\
								</div>\
								<div class="line">\
									<span class="tname">Copy to</span>\
									<div class="info-r c4">\
										<input class="bt-input-text mr5" type="text" name="forward_mail" value="" placeholder="Enter the email you need to receive the Bcc">\
									</div>\
								</div>\
								<div class="line">\
									<span class="tname">Domain</span>\
									<div class="info-r c4">\
										<input class="bt-input-text mr5" type="text" name="forward_domain" placeholder="Enter the domain you need to Bcc">\
									</div>\
								</div>\
							</div>\
						</div>',
					yes:function(index,layers){
						var type =  $("select[name='forward_type']").val(),
							user = $("input[name='forward_user']").val(),
							forward_user = $('input[name=forward_mail]').val(),
							site = $('input[name=forward_domain]').val();
						_this.set_mail_bcc({type:type,user:user,forward_user:forward_user,domain:site},function(res){
							_this.get_bcc_list();
							if(res.status) layer.msg(res.msg,{icon:res.status?1:2})
							layer.close(index)
						})
					}
				})
			});

			$('#domain_list').on('click', '.edit_ground_domain', function () {
				var domain = $(this).attr('data-domain');
				var index = $(this).attr('data-index');
				var hostname = $(this).attr('data-hostname');
				layer.open({
					type: 1,
					title: "[{1}]_User Manager".replace('{1}',domain),
					area: ['900px', '720px'],
					closeBtn: 2,
					content: '<div class="pd15 user_info">\
								<button class="btn btn-sm btn-success mb15" style="margin-right:10px;" onclick="mail.edit_mailboxs_view(true)">Add User</button>\
								<div class="member_table divtable">\
									<table class="table table-hover">\
										<thead><tr><th>Email</th><th>Nama</th><th>MailBox space</th><th>Type</th><th>Status</th><th style="text-align: right;">Operating</th></tr></thead>\
										<tbody id="mailboxs_list"></tbody>\
									</table>\
									<div class="page" id="mailboxs_page"></div>\
								</div>\
								<ul class="help-info-text c7 mlr20">\
									<li>Note: The current mail server supports IMAP/POP3/SMTP/HTTP protocol.&nbsp;<a href="javascript:;" class="btlink open_btlink_down">Download the HTTP-API documentation</a> </li>\
									<li>POP service [ ServerAddress：<b>{1}</b> Port：<b>110/995</b> ]'.replace('{1}',hostname)+'</li>\
									<li>IMAP service [ ServerAddress：<b>{1}</b> Port：<b>143/993</b> ]'.replace('{1}',hostname)+'</li>\
									<li>SMTP service [ ServerAddress：<b>{1}</b> Port：<b>25/465/587</b> ]'.replace('{1}',hostname)+'</li>\
								</ul>\
							</div>',
					success: function () {
						$('.open_btlink_down').click(function(){
							window.open('/download?filename='+encodeURIComponent('/opt/slemp/server/panel/plugin/mail_sys/static/api.zip'));
						});

						_this.create_mailboxs_list({ domain: domain});
						$('#mailboxs_list').on('click', '.open-switch-active', function () {
							var checked = $(this).prop('checked');
							var index = $(this).attr('data-index');
							var _form = _this.mailboxs_list[index];
							var quota = _form.quota / 1024 / 1024;
							var unit = ' MB';
							if(quota > 1024) {
								quota = quota / 1024;
								unit = ' GB'
							}
							_this.updatae_mailboxs({
								quota: quota + unit,
								username: _form.username,
								password: _form.password,
								quote: _form.quote,
								full_name: _form.full_name,
								active: checked ? 1 : 0,
								is_admin: _form.is_admin
							}, function (res) {
								layer.msg(res.msg, { icon: 1 });
							});
						});
						$('#mailboxs_list').on('click', '.edit_mailboxs', function () {
							var _index = $(this).attr('data-index');
							var _form = _this.mailboxs_list[_index];
							_this.edit_mailboxs_view(false, _form);
						});
						$('#mailboxs_list').on('click', '.del_mailboxs', function () {
							var username = $(this).attr('data-username');
							layer.confirm("Whether to delete the [{1}] member".replace('{1}',username), { icon: 0, closeBtn: 2, title: "Delete member" }, function (index) {
								_this.del_mailboxs({
									username: username
								}, function (res) {
									_this.create_mailboxs_list({ domain: domain}, function () {
										layer.msg(res.msg, { icon: 1 });
									});
								});
							});
						});
					}
				});
			});

			$('.task_block').on('click', '.page a', function (e) {
				var type = $(this).parent().parent().attr('data-type'),
				_p = $(this).attr('href');
				switch (type) {
					case 'get_mails_page':
						_this.create_sent_mail_list({
							p: _p
						});
					break;
					case 'junk_mails_page':
						_this.junk_mail_list({
							p: _p
						});
					break;
					case 'sent_mails_page':
						_this.create_mail_list({
							p: _p,
							size: 10
						});
					break;
				}
				e.stopPropagation();
				e.preventDefault();
			});

			$('.task_block').on('click','.add_forward',function(){
				_this.set_forward();
			});
			$('.mail_forward_list').on('click','.edit_forward',function(){
				var thistr=$(this).parents('tr'),
				user=thistr.children(":first").text(),
				goto=thistr.children(":eq(1)").text(),
				active=$(this).parent().prev().find('.btswitch-ios').prop('checked')?'checked':'';
				//active=$(this).parent().prev().text()=='Open'?'checked':'';
				_this.edit_forward(user,active,goto);
			});
			$('.mail_forward_list').on('click','.del_forward',function(){
				var user={};
				user['user'] = $(this).parents('tr').children(":first").text();
				_this.delete_forward(user);
			});
			$('.mail_forward_list').on('click','.info-r input',function(){
				var _data={}, _chose=$(this).parents('tr').find('td');
				_data['user'] = _chose.eq(0).text();
				_data['forward_user'] = _chose.eq(1).text();
				_data['active'] = $(this).is(':checked') ? 1 : 0;
				_this.edit_mail_forward(_data,function(res){
					_this.mail_forward();
					layer.msg(res.msg, { icon: res.status?1:2 });
				});
			});
			$('.select_conter input').on('focus', function (e) {
				var _that = $(this),
					mail_list = $(this).next(),
					_list = mail_list.find('li'),
					mail_default = $(this).prev(),
					html = '';
				_list.siblings().removeClass('active');
				for (var i = 0; i < _this.mail_user_list.length; i++) {
					var item = _this.mail_user_list[i];
					html += '<li ' + (_that.val() == item.username ? 'class=\"active\"' : '') + '>' + item
						.username + '</li>'
				}
				$('.domain_list').html(html);
				mail_list.width($(this)[0].clientWidth).show();
				$(document).unbind('click').on('click', function (ev) {
					if (ev.target.className.indexOf('inbox_input') == -1) {
						if (_this.is_mail != 2) {
							if (_that.val() == '' || _that.val() != mail_default.text()) {
								_that.val(mail_default.text())
							}
						}
						mail_list.hide();
					}
					ev.stopPropagation();
				});
				return false;
			});
			$('.select_conter input').on('input',function(e){
			    var _that = $(this),mail_list = $(this).next(),html = '';
			    for(var i=0;i< _this.mail_user_list.length;i++){
			        var item = _this.mail_user_list[i];
			        if(_that.val() != ''){
			            if(item.username.indexOf(_that.val()) > -1){
			                html += '<li '+ (_that.val() == item.username?'class=\"active\"':'') +'>'+ item.username +'</li>'
			            }else{
			                html += ''
			            }
			        }else{
			            html += '<li>'+ item.username +'</li>'
			        }
			    }
			    $('.domain_list').html(html);
			});
			$('.select_conter').on('click', 'li', function (e) {
				var item_val = $(this).text(),
					input = $(this).parent().prev();
				$(this).addClass('active').siblings().removeClass('active').parent().hide();
				$(this).parent().siblings(".domain_hide_value").html(item_val);
				input.val(item_val);
				switch (_this.is_mail) {
					case 0:
						//input.val(item_val);
						_this.create_mail_list({
							username: item_val
						});
						break;
					case 1:
						_this.junk_mail_list({
							username: item_val
						});
						break;
					case 2:
						//input.val(item_val);
						_this.create_sent_mail_list({
							username: item_val
						});
						break;
					// case 3:
					// 	input.val(item_val);
					// 	break;
				}
				e.preventDefault();
				e.stopPropagation();
			});
			$('.selects_conter').on('click', '.set_save_day', function (e) {
				var days = $(this).prev().val();
				if (days == '') {
					layer.msg('Save days cannot be empty！', {
						icon: 2
					});
					return false;
				}
				_this.set_save_day(days, function (res) {
					layer.msg(res.msg, {
						icon: res.status ? 1 : 2
					});
				});
				e.preventDefault();
				e.stopPropagation();
			});
			$('.mail_backup').on('click', '#backup_task', function (e) {
				$(".mail_backup_set").toggle();
				if (!$(this).prop('checked') && _this.is_mail_backup) {
					layer.confirm('Confirm to close the current backup plan?', {
						icon: 0,
						title: 'Close backup',
						closeBtn: 2,
						btn: ['Confirm', 'Cancel'],
						yes: function (index) {
							_this.close_backup_task(function (res) {
								layer.close(index)
								layer.msg(res.msg, {
									icon: res.status ? 1 : 2
								});
								_this.is_mail_backup = false;
							});
						},
						btn2: function (layers, index) {
							$('#backup_task').prop('checked',true);
							$('.mail_backup_set').show();
						},
						cancel: function (index) {
							layer.close(index)
							$('#backup_task').prop('checked',true);
							$('.mail_backup_set').show();
						},
					});
				}
			});
			$('#mail_backup_list tbody').on('click', '.opt_backup', function (e) {
				var opt = $(this).text()=='Restore'?'restore':'delete',
				_path = $(this).parent().attr('data-path');
				condent = opt=='restore'?'Confirm to restore the current backup?':'Confirm to delete the current backup?',
				_title = opt=='restore'?'Restore backup':'Delete backup';
				layer.confirm(condent, {
					icon: 0,
					title: _title,
					closeBtn: 2,
					btn: ['Confirm', 'Cancel'],
					yes: function (index) {
						if (opt=='restore') {
							_this.restore_backup_list(_path, function (res) {
								layer.msg(res.msg, {
									icon: res.status ? 1 : 2
								});
							});
						} else {
							_this.delete_backup_list(_path, function (res) {
								layer.msg(res.msg, {
									icon: res.status ? 1 : 2
								});
							});
							_this.get_backup_list();
						}
					},
				});
			});
			$('.mail_backup_set').on('click', '.backup_save', function (e) {
				var data = {};
				data.type = $('.mail_backup_set #cycle').find("b").attr('val');
				data.hour = $('.mail_backup_set .plan_hms [name="hour"]').val();
				data.minute = $('.mail_backup_set .plan_hms [name="minute"]').val();
				data.backupTo = $('.mail_backup_set [name="backupTo"]').find("b").attr('val');
				data.save = $('.mail_backup_set .plan_hms [name="save"]').val();
				if (data.type == 'week') data.week = $('.mail_backup_set #excode').find("b").attr('val');
				_this.open_backup_task(data, function (res) {
					layer.msg(res.msg, {
						icon: res.status ? 1 : 2
					});
				});
				e.preventDefault();
				e.stopPropagation();
			});
			$('.dropdown').on('click', 'ul li a', function () {
				var txt = $(this).text();
				var type = $(this).attr("value");
				if (type == 'week') {
					$("#ptime .planweek").show();
				} else if (type == 'day') {
					$("#ptime .planweek").hide();
				}
				$(this).parents(".dropdown").find("button b").text(txt).attr("val", type);
			});
			_this.check_mail_sys({tips:'Checking Mail server is normal, please wait ...',hostname:''},function(res){
				if(res.status == false && res.msg == "Have not installed the mail server before, please feel free to install"){
					layer.confirm('Mail Server is not currently installed, is it installed?', {
						icon:0,
						title: 'Mail Server initialization',
						btn: ['Confirm','Cancel'], //按钮
						cancel:function(){
							layer.closeAll();
						}
					}, function(index){
						_this.setup_mail_sys({tips:'Mail server is not initialized, is it initialized now?'},function(res){
                          layer.close(index)
                          layer.msg(res.msg,{icon:res.status?1:2});
                          _this.create_domain_list();
						});
					},function(){
						layer.closeAll();
					});
					// layer.open({
					// 	type: 1,
					// 	title: '邮局初始化',
					// 	area: ['590px', '330px'],
					// 	closeBtn: 2,
					// 	btn: ['安装', '取消'],
					// 	content:"<div class='bt-form pd20'>\
					// 		<div class='line'>\
					// 			<ul class='help-info-text c7 mlr20'>\
					// 				<li><span style='color:red'>提示： 部分云厂商(如：阿里云，腾讯云)默认关闭25端口，需联系厂商开通25端口后才能正常使用邮局服务</span></li>\
					// 			</ul>\
					// 		</div>\
					// 	</div>",
					// 	yes:function(index,layers){
					// 		var hostname = $('[name="hostname"]').val();
					// 		if(hostname == ''){
					// 			layer.msg('邮局服务器域名不能为空！',{icon:2});
					// 			return false;
					// 		}

					// 	},
					// 	btn2:function(){
					// 		layer.closeAll();
					// 	},
					// 	cancel:function(){
					// 		layer.closeAll();
					// 	}
					// })
				}else{
				  //_this.create_domain_list();
				  $('.tasklist .tab-nav span:first').click();//初始化
				}
			});
			$('body').on('change', '.turn_anti_spam', function () {
				if ($(".anti_spam_line").val()!='localhost' && $(".anti_spam_line .line").length==0) {
					$(".anti_spam_line").append('<div class="line mt10">\
                        <span style="margin-left: 27px;">Server IP:</span>\
                        <input type="text" name="spam_server_ip" class="bt-input-text" style="width: 115px;margin-left: 10px;font-size: 13px;" placeholder="127.0.0.1">\
					</div>\
					<div class="line mt10">\
                        <span style="margin-left: 12px;">Server port:</span>\
                        <input type="text" name="spam_server_port" class="bt-input-text" style="width: 115px;margin-left: 10px;font-size: 13px;" placeholder="10024">\
                    </div>')
				} else {
					$(".anti_spam_line .line").toggle();
				}
			});
			this.loadScript('/static/ckeditor/ckeditor.js', function () {
				CKEDITOR.replace('editor1', {
					customConfig: '/static/ckeditor/config.js?v1.0'
				})
			});
		},

		service_admin : function(service,type) {
			var msg = type;
			var typeName = '',
			repair_tips = '';
			switch(type){
				case 'stop':
					typeName = 'Stopping';
				break;
				case 'restart':
					typeName = 'Restarting';
				break;
				case 'reload':
					typeName = 'Reloading';
				break;
				case 'repair':
					typeName = 'Repairing';
					if (service=='postfix') {
						repair_tips = 'Config will be restored to default, and invalidate these configuration: SSL, Anti spam, BCC, SMTP Relay, mail forward. Confirm to continue?';
					} else if (service=='dovecot') {
						repair_tips = 'Config will be restored to default, and invalidate these configuration: SSL. Confirm to continue?';
					} else {
						repair_tips = 'Are you sure to repair opendkim service?';
					}
					break;
			}
			bt.confirm({msg: repair_tips == ''?'Sure' : '<div style="word-break: break-word;">'+repair_tips+'</div>', title:typeName+' '+service+' '+'Service'},function(){
				mail.send({
					tips: typeName + service + 'Service,Please wait...',
					method: type=='repair'?'repair_service_conf':'service_admin',
					data: {service:service, type:type},
					success: function (ress) {
						mail.get_service_status(function(res){
							for(var item in res){
								$('.'+item).html(res[item]?'<span style="color:#20a53a;">Running</span><span style="color:#20a53a" class="glyphicon glyphicon-play"></span>':'<span style="color:red;">Stopped</span><span style="color:red" class="glyphicon glyphicon-pause"></span>');
								switch (item){
									case 'postfix':
										$(!res[item] ? '.postfix_start' : '.postfix_stop').show();
										$(res[item] ? '.postfix_start' : '.postfix_stop').hide();
									break;
									case 'dovecot':
										$(!res[item] ? '.dovecot_start' : '.dovecot_stop').show();
										$(res[item] ? '.dovecot_start' : '.dovecot_stop').hide();
									break;
									case 'opendkim':
										$(!res[item] ? '.opendkim_start' : '.opendkim_stop').show();
										$(res[item] ? '.opendkim_start' : '.opendkim_stop').hide();
									break;
								}
							}
							layer.msg(ress.msg,{icon:1});
						});
					}
				});
			})
		},
		//上传备份邮件
		upload_files: function () {
			var _this = this;
			bt_upload_file.open(getCookie('backup_path')+'/path/', '.gz,.tar,.tar.gz,.zip', 'Upload tar.gz package', function () {
				_this.get_backup_list();
			});
		},
		//备份邮件操作
		get_backup_list: function () {
			var _this = this,
			mail_list = '';
			_this.get_backup_file_list({path:getCookie('backup_path')+'/path/'},function (rdata) {
				for (var i = 0; i < rdata.length; i++) {
					var mtime = rdata[i].mtime;
					mtime = _this.format_data(parseInt(mtime)*1000),
					_path = getCookie('backup_path')+'/path/'+rdata[i].name;
					mail_list += '<tr>\
						<td>'+rdata[i].name+'</td>\
						<td>'+mtime+'</td>\
						<td style="text-align:right" data-path="' + _path + '">\
							<a class="btlink opt_backup" herf="javascrpit:;">Restore</a>\
							| <a class="btlink opt_backup">Delect</a>\
						</td>\
					</tr>'
				}
				$('#mail_backup_list tbody').html(mail_list);
			});
		},
		// 时间戳转换
		format_data: function (tm, format) {
			if (format == undefined) format = "yyyy/MM/dd hh:mm:ss";
			tm = tm.toString();
			if (tm.length > 10) {
				tm = tm.substring(0, 10);
			}
			var data = new Date(parseInt(tm) * 1000);
			var o = {
				"M+": data.getMonth() + 1, //month
				"d+": data.getDate(), //day
				"h+": data.getHours(), //hour
				"m+": data.getMinutes(), //minute
				"s+": data.getSeconds(), //second
				"q+": Math.floor((data.getMonth() + 3) / 3), //quarter
				"S": data.getMilliseconds() //millisecond
			}
			if (/(y+)/.test(format)) format = format.replace(RegExp.$1,
				(data.getFullYear() + "").substr(4 - RegExp.$1.length));
			for (var k in o)
				if (new RegExp("(" + k + ")").test(format))
					format = format.replace(RegExp.$1,
						RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
			return format;
		},

		//邮件转发  <td>'+(res[i].active==1?'On':'Off')+'</td>
		mail_forward:function(obj,callback){
			var _this = this;
			_this.get_list(function(res){
				var cont='';
				for (var i = 0; i < res.length; i++) {
					cont += '<tr>\
								<td><span style="display:inline-block;max-width: 139px;overflow: hidden;margin: 0;text-overflow: ellipsis;">'+res[i].address+'</span></td>\
								<td><span style="display:inline-block;max-width: 139px;overflow: hidden;margin: 0;text-overflow: ellipsis;" title="'+res[i].goto+'">'+res[i].goto+'</span></td>\
								<td><span style="display:inline-block;max-width: 79px;overflow: hidden;margin: 0;text-overflow: ellipsis;">'+res[i].domain+'</span></td>\
								<td>'+res[i].created+'</td>\
								<td>'+res[i].modified+'</td>\
								<td><div class="info-r c4">\
									<input type="checkbox" id="forward_active'+i+'" '+(res[i].active==1?'checked':'')+' name="active" class="btswitch btswitch-ios">\
									<label for="forward_active'+i+'" class="btswitch-btn" style="width: 2.0em;height: 1.2em;margin-bottom: 0;"></label>\
								</div></td>\
								<td width="80" style="color: #666;"><a class="btlink edit_forward">Edit</a> | <a class="btlink del_forward">Del</a></td>\
							</tr>'
				}
				$(".mail_forward_list").html(cont);
				bt.fixed_table('mail_forward_list');
			});
		},
		//邮件转发
		set_forward:function(obj,callback){
			var _this = this;
			layer.open({
				type: 1,
				title: 'Set mail forward',
				area: '450px',
				closeBtn: 2,
				btn: ["Submit", "Cancel"],
				content: "<div class='bt-form pd20 forwardset'>\
						<div class='line'>\
							<span class='tname'>Status</span>\
							<div class='info-r c4'>\
								<input type='checkbox' id='forward_active' name='active' class='btswitch btswitch-ios'>\
								<label for='forward_active' class='btswitch-btn'></label>\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>Forwarded users</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='user' placeholder='Enter the mailbox that needs to be forwarded' style='width:250px;' />\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>Domain</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='domain' placeholder='Domain name of the Forwarded users' style='width:250px;' />\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>Receiving user</span>\
							<div class='info-r c4'>\
								<textarea class='bt-input-text mr5' type='text' name='forward_user' placeholder='Users who need to accept forwarded mail. If there are multiple, please separate them with newlines.' style='width:250px;height: 110px;'></textarea>\
							</div>\
						</div>\
					</div>",
				yes: function (index, layers) {
					var _data={};
					_data['user'] = $('[name="user"]').val();
					_data['forward_user'] = $('[name="forward_user"]').val();
					_data['domain'] = $('[name="domain"]').val();
					_data['active'] = $('#forward_active').prop('checked') ? 1 : 0;
					_this.set_mail_forward(_data,function(res){
						_this.mail_forward();
						layer.close(index);
						layer.msg(res.msg, { icon: res.status?1:2 });
					});
				}
			});
		},
		//编辑转发邮件
		edit_forward:function(user,active,goto){
			var _this = this;
			layer.open({
				type: 1,
				title: 'Set mail forward',
				area: '450px',
				closeBtn: 2,
				btn: ["Submit", "Cancel"],
				content: "<div class='bt-form pd20 forwardset'>\
						<div class='line'>\
							<span class='tname'>Status</span>\
							<div class='info-r c4'>\
								<input type='checkbox' id='forward_active' name='active' class='btswitch btswitch-ios' "+active+">\
								<label for='forward_active' class='btswitch-btn'></label>\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>User</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='user' value='"+user+"' readonly style='width:250px;' />\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>Forward user</span>\
							<div class='info-r c4'>\
								<textarea class='bt-input-text mr5' type='text' name='forward_user' placeholder='Multiple separated by line break' style='width:250px;height: 110px;'>"+goto+"</textarea>\
							</div>\
						</div>\
						<ul class='help-info-text c7'>\
			            	<li>The multiple mailboxes to be forwarded, separated by line breaks.</li>\
			            </ul>\
					</div>",
				yes: function (index, layers) {
					var _data={};
					_data['user'] = $('[name="user"]').val();
					_data['forward_user'] = $('[name="forward_user"]').val();
					_data['active'] = $('#forward_active').prop('checked') ? 1 : 0;
					_this.edit_mail_forward(_data,function(res){
						_this.mail_forward();
						layer.close(index);
						layer.msg(res.msg, { icon: res.status?1:2 });
					});
				}
			});
		},
		//删除转发邮件
		delete_forward:function(user){
			var _this = this;
			layer.confirm('Confirm to delect this mail foward?',{title: 'Delect mail forward',btn: ["Submit", "Cancel"],closeBtn:2},function(index, layero){
				_this.delete_mail_forward(user,function(res){
					_this.mail_forward();
					layer.msg(res.msg, { icon: res.status?1:2 });
				});
            });
		},

		//获取smtp设置
		get_smtp: function (obj, callback) {
			var _this = this;
			_this.get_smtp_status(function (res) {
				var smtp_status = res.status;
				$("#checksmtp").prop('checked', smtp_status);
				$(".smtp").css('display', smtp_status ? 'block' : 'none');
				if (smtp_status) {
					$(".smtp input[name='smtp_username']").val(res.msg.user);
					$(".smtp input[name='passwd']").val(res.msg.passwd);
					$(".smtp input[name='port']").val(res.msg.port);
					$(".smtp input[name='smtphost']").val(res.msg.host);
				}
			});
		},

		// 获取安装邮局服务
		setup_mail_sys:function(obj,callback){
			this.send({
				tips: obj.tips,
				method: 'setup_mail_sys',
				data:{hostname:obj.hostname},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},

		// 编辑邮箱用户视图
		edit_mailboxs_view: function (type, obj) {
			var _this = this;
			if (obj == undefined) {
				obj = {
					is_admin: 0,
					username: '',
					password: '',
					quota: 5368709120,
					full_name: '',
					department: '',
					position: '',
					phone: '',
					sex: 0
				}
			}
			var quota_size = (obj.quota / 1024 / 1024 / 1024) < 1 ? (obj.quota / 1024 / 1024) : (obj.quota / 1024 / 1024/ 1024);
			layer.open({
				type: 1,
				title: type ? "Add User": "Edit User",
				area: '450px',
				closeBtn: 2,
				btn: [type ? "Submit" : "Save", "Cancel"],
				content: "<div class='bt-form pd20'>\
						<div class='line'>\
							<span class='tname'>User Type</span>\
							<div class='info-r c4'>\
								<select name='is_admin' class='bt-input-text'>\
									<option value='0' "+ (obj.is_admin == 0 ? 'selected' : '') + ">General user</option>\
									<option value='1' "+ (obj.is_admin == 1 ? 'selected' : '') + ">Admin</option>\
								</select>\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>Name</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='full_name' value='"+ obj.full_name + "' placeholder='Enter the username please' style='width:250px;' />\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>Email</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='username' "+ (!type ? 'readonly' : '') + " placeholder='Enter the email address please' value='" + obj.username.split('@')[0] + "' placeholder='' style='width:151px' />@" + mail._domain_name + "\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>Password</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='password' value='"+ (obj.password || '') + "' placeholder='" + (!type ? "If it is empty, the password will not be changed." : "Enter your email password please") + "' style='width:250px;' />\
							</div>\
						</div>\
						<div class='line'>\
							<span class='tname'>MailBox space</span>\
							<div class='info-r c4'>\
								<input class='bt-input-text mr5' type='text' name='quota' value='"+ quota_size + "' placeholder='Enter the size of MailBox' style='width:183px;' />\
								<select name='quota_size' class='bt-input-text'>\
									<option value=' GB' "+ (obj.quota / 1024 / 1024 / 1024 >= 1 ? 'selected' : '') + ">GB</option>\
									<option value=' MB' "+ (obj.quota / 1024 / 1024 / 1024 < 1 ? 'selected' : '') + ">MB</option>\
								</select>\
							</div>\
						</div>\
					</div>",
				yes: function (index, layers) {
					var array = [['username', 'Email address cannot be empty'], ['quota', 'MailBox size cannot be empty'], ['full_name', 'Username cannot be empty']], _form = {}, tel_reg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/,paw_reg = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).*$/
					for (var i = 0; i < array.length; i++) {
						if ($('[name="' + array[i][0] + '"]').val() == '') {
							layer.msg(array[i][1], { icon: 2 });
							return false;
						} else if (array[i][0] == 'phone' && !tel_reg.test($('[name="' + array[i][0] + '"]').val())) {
							layer.msg("Member phone number format is wrong, please try again", { icon: 2 });
							return false;
						}
						_form[array[i][0]] = $('[name="' + array[i][0] + '"]').val();
					}
					_form['quota'] = _form['quota'] + $('[name="quota_size"]').val();
					_form['sex'] = $('[name="sex"]:checked').val();
					_form['is_admin'] = $('[name="is_admin"]').val();
					_form['password'] = $('[name="password"]').val();
					_form['username'] = $('[name="username"]').val() + '@' + mail._domain_name;
					if(type){
						if(_form['password'].length <8){
							layer.msg('The current mailbox user password length is less than 8 digits, please re-enter',{icon:0});
							return false;
						}else if(!paw_reg.test(_form['password'])){
							layer.msg('The current mailbox user password must contain at least uppercase and lowercase letters and numbers. Please re-enter',{icon:0});
							return false;
						}
						_this.add_mailboxs(_form, function (res) {
							_this.create_mailboxs_list({ domain: _this._domain_name}, function () {
								if(res.status) _this.is_update = true;
								layer.msg(res.msg, { icon: 1 });
								layer.close(index);
							});
						});
					} else {
						_form['active'] = obj.active;
						_this.updatae_mailboxs(_form, function (res) {
							_this.create_mailboxs_list({ domain: _this._domain_name}, function () {
								layer.msg(res.msg, { icon: 1 });
								layer.close(index);
							});
						});
					}
				}
			});
		},

		// 设置解析邮箱-方法
		set_analysis_mail:function(dkim_value,dmarc_value,domain,hostname){
			var _this = this;
			layer.open({
				type:1,
				title:"[{1}] add record value".replace('{1}',domain),
				area:'750px;',
				closeBtn:2,
				content:"<div class='bt-body divtable pd20'>\
					<div class='bt_tips'>Step 1: Add MX records</div>\
					<div class='bt_conter'>\
						<div class='bt_vice_tips'>Login to the domain name service provider and add a record with the record type MX for the mailbox service (please copy the following parameters directly)</div>\
						<div class='bt_vice_conter'>\
							<table class='table table-hover'>\
								<thead><tr><th>Record type</th><th>Host record</th><th>Record value</th><th>MX priority</th></tr></thead>\
								<tbody>\
								  <tr><td>MX</td><td>@</td><td>"+ hostname + "</td><td>10</td></tr>\
								</tbody>\
							</table>\
						</div>\
					</div>\
					<div class='bt_tips'>Step 2: Add TXT record</div>\
					<div class='bt_conter'>\
						<div class='bt_vice_tips'>Add records with record type TXT for mailbox anti-spam (please copy the following parameters directly)</div>\
						<div class='bt_vice_conter'>\
							<table class='table table-hover'>\
								<thead><tr><th>Record type</th><th>Host record</th><th>Record value</th></tr> </thead>\
								<tbody>\
                                  <tr><td>TXT</td><td>@</td><td>v=spf1 a mx ~all&nbsp;<a href='javascript:;' class='btlink btn_copy' data-clipboard-text='v=spf1 a mx ~all'>( Copy )</a>&nbsp;</td></tr>\
                                  <tr><td>TXT</td><td>default._domainkey</td><td><span style='width:150px;word-break:break-all;'>"+ dkim_value +"</span>&nbsp;<a href='javascript:;' class='btlink btn_copy' data-clipboard-text='"+ dkim_value +"'>( Copy )</a>&nbsp;</td></tr>\
                                  <tr><td>TXT</td><td>_dmarc</td><td>"+ dmarc_value +"&nbsp;<a href='javascript:;' class='btlink btn_copy' data-clipboard-text='"+ dmarc_value +"'>( Copy )</a>&nbsp;</td></tr>\
								</tbody>\
							</table>\
						</div>\
					</div>\
					<div class='bt_center'><button class='btn btn-success btn-sm btn_set_analysis'>Already set, Verify domain name resolution</button></div>\
				</div>",
				success:function(layers,index){
					var copyBtn = new ClipboardJS('.btn_copy');
					copyBtn.on("success",function(e){
						layer.msg("Successful copy",{icon:1})
						e.clearSelection();
					});
					copyBtn.on("error",function(e){
						layer.msg("Copy failed, please copy the text manually",{icon:2})
					});
					$('.btn_set_analysis').click(function(){
                      	_this.delete_mx_txt_cache({domain:domain},function(res){
							_this.create_domain_list();
							layer.close(index);
						});
					});
				}
			});
		},

		// 编辑添加邮箱用户视图-方法
		edit_domain_view:function(type, obj) {
			var _this = this;
			if (obj == undefined) {
				obj = {
					domain: '',
					company_name: '',
					admin_name: '',
					admin_phone: ''
				}
			}
			layer.open({
				type: 1,
				title: type ? "Add Domain" : "Edit Domain",
				area: '500px',
				closeBtn: 2,
				btn: [type ? "Submit" : "Save", "Cancel"],
				content: "<div class='bt-form pd20'>\
					<div class='line'>\
						<span class='tname'>Domain name</span>\
						<div class='info-r c4'>\
							<input class='bt-input-text mr5' type='text' name='domain'  "+ (!type ? "readonly='readonly'" : "") + "	 value='" + obj.domain + "' placeholder='Please enter a domain name, e.g: aapanel.com' style='width:320px;' />\
						</div>\
					</div>\
					<div class='line'>\
						<span class='tname'>A record</span>\
						<div class='info-r c4'>\
							<input class='bt-input-text mr5' type='text' name='a_record'  "+ (!type ? "readonly='readonly'" : "") + "	 value='" + obj.domain + "' placeholder='Please enter A record e.g: mail.aapanel.com' style='width:320px;' />\
						</div>\
					</div>\
					<div class='line'>\
						<ul class='help-info-text c7 mlr20' style='margin-top: 0px'>\
							<li style='color: red;'>Prompt that the A record resolution failed. Please check whether the filled A record domain name has been resolved to the server IP</li>\
							<li>A record needs to be added to your DNS service provider console.</li>\
							<li>If you use CloudFlare, please select [DNS only] when adding records.</li>\
						</ul>\
					</div>\
				</div>",
				yes: function (index, layers) {
					var array = [['domain', 'Mailbox domain name cannot be empty! ','a_record','A record value cannot be empty!']], _form = {}, tel_reg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/;
					for (var i = 0; i < array.length; i++) {
						if ($('[name="' + array[i][0] + '"]').val() == '') {
							layer.msg(array[i][1], { icon: 2 });
							return false;
						} else if (array[i][0] == 'admin_phone' && !tel_reg.test($('[name="' + array[i][0] + '"]').val())) {
							layer.msg("Manage phone number format error, please try again", { icon: 2 });
							return false;
						}
						_form[array[i][0]] = $('[name="' + array[i][0] + '"]').val();
						_form[array[i][2]] = $('[name="' + array[i][2] + '"]').val();
					}
					if (type) {
						_this.add_domain(_form, function (res) {
							_this.create_domain_list({ page: 1, size: 10 }, function (res) {
								var rdata = res.msg.data, hostname = rdata;
								for(var i = 0;i<rdata.length;i++){
									if(rdata[i].domain == _form['domain']) hostname = rdata[i]['domain']
								}
								layer.close(index);
							});
						});
					} else {
						_form['active'] = obj.active;
						_this.update_domain(_form, function (res) {
							_this.create_domain_list({ page: 1, size: 10 }, function (res) {
								layer.msg(res.msg, { icon: 1 });
								layer.close(index);
							});
						});
					}
				}
			})
		},
		//开关反垃圾邮件
		turn_anti_spam:function() {
			var _this = this,
			_type = $('#anti_spam').prop("checked"),
			_url = 'turn_off_anti_spam',
			_tips = 'Shutting down the anti spam service, please wait...',
			_html = 'Whether to close the anti spam service?',
			_data = {spam_server_ip:'localhost',spam_server_port:''};
			if (!_type) {//开启反垃圾邮件
				_url = 'turn_on_anti_spam';
				_tips = 'Openning up the anti spam service, please wait...';
				_html = '<div class="anti_spam_line" style="padding-left: 13px;"><span style="margin-left: 43px;">Server: </span>\
				<select class="bt-input-text  turn_anti_spam" name="turn_anti_spam" style="width: 115px;margin-left: 10px;font-size: 12px;">\
					<option value="localhost">Localhost</option>\
					<option value="">Specific server</option>\
				</select></div>';
			}
			layer.confirm(_html, {closeBtn: 2, title:'Anti spam settings',
				yes: function(index){
					if($(".turn_anti_spam").val()!='localhost'){
						for (var i = 0; i < $(".anti_spam_line input").length; i++) {
							var _input = $(".anti_spam_line .line").eq(i).find('input');
							if(_input.val()=='') {
								_input.focus();
								return false;
							}
						}
						_data.spam_server_ip = $(".anti_spam_line [name='spam_server_ip']").val();
						_data.spam_server_port = $(".anti_spam_line [name='spam_server_port']").val();
					}
					_this.send({
						tips: _tips,
						method: _url,
						data: _data,
						success: function(res){
							if(!res.status) layer.close(index);
							layer.msg(res.msg, { icon: 1 });
						}
					})
				},
				btn2:function(layers,index){
					$('#anti_spam').prop("checked",_type);
				},
				cancel: function(index, layero){
					$('#anti_spam').prop("checked",_type);
				}
			});
		},
		// 打开ssl证书
		open_certificate_view:function(status,site){
			var _this = this;
			_this.get_certificate_status(site,function(res){
				var key = status=='true'?res.key:'',
				csr = status=='true'?res.csr:'';
				layer.open({
					type: 1,
					title: status=='true'?'Edit SSL':'Add SSL',
					area: '550px',
					closeBtn: 2,
					btn: ['Save','Cancel','Delete'],
					content: "<div class='tab-con'>\
								<div>\
									<div>\
										<span>Private key (KEY)</span>\
										<span style='padding-left:165px'>Certificate (CRT/PEM)</span>\
									</div>\
								</div>\
								<div class='line'> \
									<div class='ml0'> \
										<textarea class='bt-input-text mr20 key' name='key' style='width:45%;height:220px;line-height:22px'>"+ key +"</textarea> \
										<textarea class='bt-input-text mr20 csr' name='csr' style='width:45%;height:220px;line-height:22px'>"+ csr +"</textarea> \
									</div>\
								</div></div>",
					success: function(layers){
						layers.find('.layui-layer-btn2').css('margin', '0 315px 0 0');
						if(status=='false') $('.layui-layer-btn2').hide();
					},
					yes: function(layers,index) {
						var keyValue = $('.key').val();
						var csrValue = $('.csr').val();
						if(keyValue == '' || csrValue == ''){
							layer.msg('Certificate cannot be empty',{icon:2});
						}else{
							_this.set_mail_certificate_multiple({domain:site,csr:csrValue,key:keyValue,act:'add'},function(res){
								_this.create_domain_list();
								layer.close(layers);
								layer.msg(res.msg,{icon:res.status?1:2});
							})
						}
					},
					btn2:function(layers,index){
						layer.close(layers);
					},
					btn3:function(layers,index){
						var keyValue = $('.key').val();
						var csrValue = $('.csr').val();
						layer.confirm('Whether to delete the SSL certificate?', {icon: 0,closeBtn: 2, title:'Confirm delete?',
							yes: function(layero){
								_this.set_mail_certificate_multiple({domain:site,csr:csrValue,key:keyValue,act:'delete'},function(res){
									_this.create_domain_list();
									layer.close(layero);
									layer.msg(res.msg,{icon:res.status?1:2});
								})
							},
							btn2:function(layero){
								layer.close(layero);
							},
							cancel: function(layero){
								layer.close(layero);
							}
						});
					},
					cancel:function(layers,index){
						layer.close(layers);
					}
				})
			});
		},

		// 提交发送邮箱请求-方法
		sublimt_send_mail_request:function(type) {
			var _this = this;
			var mail_to = $('[name="mail_to"]').val();
			mail_to = JSON.stringify(mail_to.split(','))
			var subject = $('[name="subject"]').val();
			var data = CKEDITOR.instances.editor1.getData();
			if (mail_to == '') {
				layer.msg("Enter the recipient please", { icon: 0 });
				return false;
			} else if (subject == '') {
				layer.msg("Enter the subject of the email please", { icon: 0 });
				return false;
			} else if (data == '') {
				layer.msg("Enter the content of the email please", { icon: 0 });
				return false;
			}
			this.send_mail_conter({
				mail_from: $('.domain_input:eq(2)').val(),
				mail_to: mail_to,
				subject: subject,
				content: data,
				subtype: 'html',
				smtp_server: 'localhost'
			}, function (res) {
				layer.msg(res.msg, { icon: 1 });
				$('[name="subject"]').val('')
				CKEDITOR.instances.editor1.setData('')
			})
		},
		//清除发送邮件
		clear_send_mail:function(){
		    layer.confirm('Clean up current content?',{title:'Empty content',icon:0,closeBtn:2},function(indes,layers){
		        $('.domain_input,[name="mail_to"],[name="subject"]').val('');
		        CKEDITOR.instances.editor1.setData('');
		        layer.close(indes);
		    })
		},

		// 创建邮件用户列表 -方法
		create_mailboxs_list:function(obj, callback) {
			var _this = this;
			this.get_mailboxs_list(obj, function (res) {
				var _tbody = '', rdata = res.data;
				_this.mailboxs_list = rdata
				_this._domain_name = obj.domain;
				if(rdata.length > 0){
                  for (var i = 0; i < rdata.length; i++) {
                      var quota_size = (rdata[i].quota / 1024 / 1024 / 1024) < 1 ? (rdata[i].quota / 1024 / 1024)+'MB' : (rdata[i].quota / 1024 / 1024/ 1024)+'GB';
                      _tbody += '<tr><td>' + rdata[i].username + '</td><td>' + rdata[i].full_name + '</td><td>' + quota_size + '</td><td>' + (!rdata[i].is_admin ? "General user" : "Admin") + '</td><td><div class="index-item"><input class="btswitch btswitch-ios open-switch-active" id="is_active_' + i + '" type="checkbox" ' + (rdata[i].active == 1 ? "checked" : "") + ' data-index="' + i + '"><label class="btswitch-btn" for="is_active_' + i + '"></label></div></td><td style="text-align: right;"><a href="javascript:;" class="btlink edit_mailboxs" data-index="' + i + '">Edit</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="javascript:;" class="btlink red del_mailboxs" data-username="' + rdata[i].username + '">Delete</a></td></tr>';
                  };
                }
				$('#mailboxs_list').html(_tbody);
				$('#mailboxs_page').html(res.page);
				$('#mailboxs_page a').click(function (e) {
					_this.create_mailboxs_list({p: $(this).attr('href').split('p=')[1], domain: _this._domain_name});
					e.stopPropagation();
					e.preventDefault();
				})
				if (callback) callback(res);
			});
		},

		// 创建域名列表-方法
		create_domain_list:function(obj, callback) {
			if (obj == undefined) obj = { page: 1, size: 10 }
			var _this = this;
			this.get_domain_list(obj, function (res) {
				var _tbody = '', rdata = res.msg.data;
				_this.domain_list = rdata
              	if(rdata.length > 0){
                  for (var i = 0; i < rdata.length; i++) {
                      _tbody += '<tr>\
                          <td>' + rdata[i].domain + '</td>\
                          <td>' + (rdata[i].mx_status ? '<div style="color:#20a53a;"><span class="glyphicon glyphicon-ok" style="margin-right: 7px;"></span>OK</div>' : '<div style="color:red;display: inline-block;"><span class="glyphicon glyphicon-remove" style="margin-right: 7px;"></span><a href="javascript:;" style="color:red" onclick="mail.set_analysis_mail(\''+ rdata[i].dkim_value +'\',\''+ rdata[i].dmarc_value +'\',\''+ rdata[i].domain +'\',\''+ rdata[i].mx_record +'\')">Not Set</a></div>') + '</td>\
						  <td>' + (rdata[i].a_status ? '<div style="color:#20a53a;"><span class="glyphicon glyphicon-ok" style="margin-right: 7px;"></span>OK</div>' : '<div style="color:red;display: inline-block;"><span class="glyphicon glyphicon-remove" style="margin-right: 7px;"></span><a href="javascript:;" style="color:red" onclick="mail.set_analysis_mail(\''+ rdata[i].dkim_value +'\',\''+ rdata[i].dmarc_value +'\',\''+ rdata[i].domain +'\',\''+ rdata[i].mx_record +'\')">Not Set</a></div>') + '</td>\
                          <td>' + (rdata[i].spf_status ? '<div style="color:#20a53a;"><span class="glyphicon glyphicon-ok" style="margin-right: 7px;"></span>OK</span></div>' : '<div style="color:red;display: inline-block;"><span class="glyphicon glyphicon-remove" style="margin-right: 7px;"></span><a href="javascript:;" style="color:red" onclick="mail.set_analysis_mail(\''+ rdata[i].dkim_value +'\',\''+ rdata[i].dmarc_value +'\',\''+ rdata[i].domain +'\',\''+ rdata[i].mx_record +'\')">Not Set</a></div>') + '</td>\
                          <td>' + (rdata[i].dkim_status ? '<div style="color:#20a53a;"><span class="glyphicon glyphicon-ok" style="margin-right: 7px;"></span>OK</span></div>' : '<div style="color:red;display: inline-block;"><span class="glyphicon glyphicon-remove" style="margin-right: 7px;"></span><a href="javascript:;" style="color:red" onclick="mail.set_analysis_mail(\''+ rdata[i].dkim_value +'\',\''+ rdata[i].dmarc_value +'\',\''+ rdata[i].domain +'\',\''+ rdata[i].mx_record +'\')">Not Set</a></div>') + '</td>\
                          <td>' + (rdata[i].dmarc_status ? '<div style="color:#20a53a;"><span class="glyphicon glyphicon-ok" style="margin-right: 7px;"></span>OK</span></div>' : '<div style="color:red;display: inline-block;"><span class="glyphicon glyphicon-remove" style="margin-right: 7px;"></span><a href="javascript:;" style="color:red" onclick="mail.set_analysis_mail(\''+ rdata[i].dkim_value +'\',\''+ rdata[i].dmarc_value +'\',\''+ rdata[i].domain +'\',\''+ rdata[i].mx_record +'\')">Not Set</a></div>') + '</td>\
                          <td><div><input type="checkbox" id="'+ rdata[i].domain +'" '+(rdata[i].catch_all ? 'checked':'')+' class="btswitch btswitch-ios catch_all"><label for="'+ rdata[i].domain +'" class="btswitch-btn"></label></div></td>\
                          <td style="text-align: right;">\
                            <a href="javascript:;" class="btlink edit_ground_domain" data-hostname="'+ rdata[i].mx_record +'" data-domain="' + rdata[i].domain + '" data-index="'+ i +'">User</a>&nbsp;|&nbsp;\
                              <a href="javascript:;" class="btlink add_certificate" onclick="mail.open_certificate_view(\''+ rdata[i].ssl_status +'\',\''+ rdata[i].domain +'\')">'+(rdata[i].ssl_status?'Edit SSL':'Add SSL')+'</a>&nbsp;|&nbsp;\
							  <a href="javascript:;" class="btlink red del_domain" data-domain="' + rdata[i].domain + '">Delete</a>\
                          </td>\
                          </tr>';
                  };
                }
				$('#domain_list').html(_tbody);
				$('#domain_page').html(res.msg.page);
				$('#domain_page a').click(function (e) {
					_this.create_domain_list({page: $(this).attr('href').split('p=')[1],size:10})
					e.stopPropagation();
					e.preventDefault();
				})
				$('#flush_domain_record').unbind().on('click',function(e){
				    _this.flush_domain_record('all',function(res){
				        layer.msg(res.msg, { icon: res.status ? 1 : 2 });
				    });
				})
				$('.catch_all').click(function (e) {
				    e.preventDefault();
					var _catch = $(this),
					_status = $(this).prop('checked'),
        			_html = _status ? '<div style="font-size: 12px;"><span>Forward email</span><input class="bt-input-text mr5 catchall" type="text" name="catchall" placeholder="Catch non-existent mail, forward to this mail" style="width:275px;margin-left: 10px;"></div>' : 'Confirm to turn off the catch function?',
        			loadT = layer.confirm(_html, {title:'Catch email', closeBtn: 2, area: '500'},function(){
        			    var _email = _status ? $(".catchall").val() : '',
        			    loadS = bt.load();
                        _this.enable_catchall({domain:_catch.attr('id'), email: _email},function(res){
                            loadS.close();
                            if(res.status) _catch.prop('checked', _status);
            				layer.msg(res.msg, { icon: res.status ? 1 : 2 });
            				loadT.close();
            			})
                    });
				})
				if (callback) callback(res);
			});
		},
		// 获取转发邮件列表
		get_bcc_list: function(){
			var _this = this;
			this.get_bcc(function(res){
				_this.forward_list.recipient = res.recipient;
				_this.forward_list.sender = res.sender;
				_this.recipient_view();
				_this.sender_view();
			})
		},
		// 接受者邮箱列表
		recipient_view: function(){
			var _this = this,tbody =''; rdata = _this.forward_list.recipient;
			for(var i =0; i<rdata.length; i++){
				tbody += '<tr>\
					<td style="width: 30%;">'+rdata[i].user+'</td>\
					<td style="width: 30%;">'+rdata[i].forward_user+'</td>\
					<td style="text-align: right;"><a class="btlink" style="color:red" onclick="mail.del_bcc_info(\'recipient\','+i+')">Del</td>\
				</tr>'
			}
			$('#recipient_list').html(tbody);
		},
		// 发件人邮箱列表
		sender_view: function(){
			var _this = this,tbody =''; rdata = _this.forward_list.sender;
			for(var i =0; i<rdata.length; i++){
				tbody += '<tr>\
					<td style="width: 30%;">'+rdata[i].user+'</td>\
					<td style="width: 30%;">'+rdata[i].forward_user+'</td>\
					<td style="text-align: right;"><a class="btlink" style="color:red" onclick="mail.del_bcc_info(\'sender\','+i+')">Del</td>\
				</tr>'
			}
			$('#sender_list').html(tbody);
		},
		// 删除转发信息
		del_bcc_info(type,index){
			var _this = this,_forwardU='',_user='';
			layer.confirm('Whether to delete the forward setting',{ icon: 0, closeBtn: 2, title: 'Delete forward' }, function (e) {
				if(type == 'recipient'){
					_forwardU = _this.forward_list.recipient[index].forward_user;
					_user = _this.forward_list.recipient[index].user;
				}else{
					_forwardU = _this.forward_list.sender[index].forward_user;
					_user = _this.forward_list.sender[index].user;
				}
				_this.del_bcc({type:type,forward_user:_forwardU,user:_user},function(res){
					if(res.status) layer.msg(res.msg,{icon:res.status?1:2})
					_this.get_bcc_list()
				})
			})
		},
		// 获取发件箱列表 -方法
		get_domains_html:function(callback){
			var _this = this;
			_this.get_all_user(function(res){
				//_this.is_update?_this.create_domains_html(res):'';
				if(callback) callback(res);
			});
		},

		// 创建发件箱列表-方法
		create_sent_mail_list:function(obj,callback){
			var _this = this,val = $('.domain_input:eq('+ _this.is_mail +')').val(),username = '';
			if(!obj) obj = { p:1 }
			_this.get_save_day(function (res) {
				$(".selects_conter .mail_day").val(res);
			});
			_this.get_domains_html(function(ress){
				if(typeof obj.username == 'undefined'){
					if(_this.active_username != ''){
						obj.username = _this.active_username;
					}else{
						if (ress.length > 0) {
							obj.username = ress[0].username;
						} else {
							return false;
						}
					}
			    }
				if(typeof obj.p == 'undefined') obj.p =1
				_this.get_sent_mails(obj, function (res){
					_this.active_username = obj.username;
					var rdata = res.data, _tbody = '', time = '', subject = '';
					_this.mail_list = res.data;
					if(!(res.status == false && res.msg == 'The account name is invalid.')){
						if(rdata.length >0){
							for (var i = 0; i < rdata.length; i++) {
								var _html = rdata[i].html.replace(/[^\u4e00-\u9fa5]/g,'');
								_html = _html.substr(0,100);
								if(_html == '') _html = rdata[i].body;
								_tbody += '<tr>\
										<td><span style="display: block;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;width:150px" title="' + _this.htmlEscape(rdata[i].to) + '">' + _this.htmlEscape(rdata[i].to) + '</span></td>\
										<td><a href="javascript:;" class="btlink mail_html" style="width:320px;"  onclick="mail.check_mail_view(' + i + ')">' + rdata[i].subject + '<span>&nbsp;-&nbsp;' + _html + '</span></a></td>\
										<td>' + bt.format_data(rdata[i].time) + '</td>\
										<td style=""><a href="javascript:;" class="btlink" onclick="mail.check_mail_view(' + i + ')">Check Mail</a> | <a href="javascript:;" class="btlink" onclick="mail.del_mail_view(' + i + ')">Del</a></td>\
									</tr>'
							}
						}
					}
					$('#mails_lists').html(_tbody);
					$('#mailListTables').parent().next('.page').remove();
					$('#mailListTables').parent().after('<div class="page sent_mails_page" style="margin-top:10px;">'+ res.page +'</div>');
        			_this.table_auto_width('.mail_html',0.32);
					_this.tableAutoWidth('#mailListTables',13);
					if(callback) callback(res);
				});
			});
		},

		// 创建邮箱列表-方法
		create_mail_list: function (obj, callback) {
			var _this = this,
				val = $('.domain_input:eq(' + _this.is_mail + ')').val(),
				username = '';
			if (!obj) obj = { p: 1 };
			_this.get_save_day(function (res) {
				$(".selects_conter .mail_day").val(res);
			});
			this.get_domains_html(function (ress) {
				if (typeof obj.username == 'undefined') {
				    if(_this.active_username != ''){
				        obj.username = _this.active_username;
				    }else{
				        if (ress.length > 0) {
    						obj.username = ress[0].username;
    					} else {
    						return false;
    					}
				    }
				}
				if (typeof obj.p == 'undefined') obj.p = 1
				_this.get_mail_list(obj, function (res) {
				    _this.active_username = obj.username;
					var rdata = res.data,
						_tbody = '',
						time = '',
						subject = '';
					_this.mail_list = res.data;
					if(!(res.status == false && res.msg == 'The account name is invalid.')){
						if(rdata.length >0){
							for (var i = 0; i < rdata.length; i++) {
								var _html = rdata[i].html.replace(/[^\u4e00-\u9fa5]/g, '');
								_html = _html.substr(0, 100);
								if (_html == '') _html = rdata[i].body;
								_tbody +=
									'<tr><td><span style="display: block;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;width:150px" title="' +
									_this.htmlEscape(rdata[i].from) + '">' + _this.htmlEscape(
										rdata[i].from) +
									'</span></td><td><a href="javascript:;" class="btlink mail_html" style="max-width:370px;" onclick="mail.check_mail_view(' +
									i + ')">' + rdata[i].subject + '<span>&nbsp;-&nbsp;' + _html +
									'</span></a></td><td>' + bt.format_data(rdata[i].time) +
									'</td><td style="text-align: right"><a href="javascript:;" class="btlink" onclick="mail.check_mail_view(' +
									i +
									')">Check mail</a> | <a href="javascript:;" class="btlink" onclick="mail.set_junk_mail(\'' + rdata[i].path + '\',\'' + _this.active_username + '\')">Mark as spam</a> | <a href="javascript:;" class="btlink" onclick="mail.del_mail_view(' +
									i + ')">Del</a></td></tr>'
							}
						}
					}
					$('#mails_list').html(_tbody);
					$('#mailListTable').parent().next('.page').remove();
					$('#mailListTable').parent().after('<div class="page" data-type="get_mails_page" style="margin-top:10px;">' + res.page + '</div>');
					//_this.table_auto_width('.mail_html', 0.32);
					//_this.tableAutoWidth('#mailListTable', 13);
					if (callback) callback(res);
				});
			});
		},

		// 垃圾邮箱列表-方法
		junk_mail_list: function (obj, callback) {
			var _this = this,
				val = $('.domain_input:eq(' + _this.is_mail + ')').val(),
				username = '';
			if (!obj) obj = { p: 1 };
			_this.get_save_day(function (res) {
				$(".selects_conter .mail_day").val(res);
			});
			this.get_domains_html(function (ress) {
				if (typeof obj.username == 'undefined') {
				    if(_this.active_username != ''){
				        obj.username = _this.active_username;
				    }else{
				        if (ress.length > 0) {
    						obj.username = ress[0].username;
    					} else {
    						return false;
    					}
				    }
				}
				if (typeof obj.p == 'undefined') obj.p = 1
				_this.get_junk_mails(obj, function (res) {
				    _this.active_username = obj.username;
					var rdata = res.data,
						_tbody = '',
						time = '',
						subject = '';
					_this.mail_list = res.data;
					if (!(res.status == false && res.msg == 'Invalid account name, for example: xx@example.com')) {
						if (rdata.length > 0) {
							for (var i = 0; i < rdata.length; i++) {
								var _html = rdata[i].html.replace(/[^\u4e00-\u9fa5]/g, '');
								_html = _html.substr(0, 100);
								if (_html == '') _html = rdata[i].body;
								_tbody +=
									'<tr><td><span style="display: block;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;width:150px" title="' +
									_this.htmlEscape(rdata[i].from) + '">' + _this.htmlEscape(rdata[i].from) +
									'</span></td><td><a href="javascript:;" class="btlink mail_html" style="max-width:370px;" onclick="mail.check_mail_view(' +
									i + ')">' + rdata[i].subject + '<span>&nbsp;-&nbsp;' + _html +
									'</span></a></td><td>' + bt.format_data(rdata[i].time) +
									'</td><td style="text-align: right"><a href="javascript:;" class="btlink" onclick="mail.check_mail_view(' + i +
									')">Check mail</a> | <a href="javascript:;" class="btlink" onclick="mail.move_out_junk(\'' + rdata[i].path + '\',\'' + _this.active_username + '\')">Unmark</a> | <a href="javascript:;" class="btlink" onclick="mail.del_mail_view(' + i + ')">Del</a></td></tr>'
							}
						}
					}
					$('#junks_list').html(_tbody);
					$('#junkListTable').parent().next('.page').remove();
					$('#junkListTable').parent().after('<div class="page" data-type="junk_mails_page" style="margin-top:10px;">' + res.page + '</div>');
					//_this.table_auto_width('.mail_html', 0.32);
					//_this.tableAutoWidth('#junkListTable', 13);
					if (callback) callback(res);
				});
			});
		},

		// 查看邮件视图-方法
		check_mail_view: function(index) {
			var item = this.mail_list[index], _this = this;
			layer.open({
				type: 1,
				title: 'Check Mail [' + item.subject + ']',
				area: ['850px','800px'],
				maxmin:true,
				// btn: [ !_this.is_mail?lan.mail_sys.reply_mail:'Sending', lan.public.cancel],
				content: "<div class='bt-form'>\
					<div class='mail_title'>\
						<ul>\
							<li style='margin-bottom:5px;'><h4>Theme:"+ item.subject + "</h4></li>\
							<li>Sender: "+ _this.htmlEscape(item.from) + "</li>\
							<li>Time: "+ bt.format_data(item.time) + "</li>\
							<li>Recipient: "+ _this.htmlEscape(item.to) + "</li>\
						</ul>\
					</div>\
					<div class='mail_conter pd15'></div>\
				</div>",
				success: function (layers, indexs) {
					if (document.head.createShadowRoot || document.head.attachShadow) {
						var shadow = document.querySelector('.mail_conter').attachShadow({
							mode: 'open'
						});
						shadow.innerHTML = item.html == '' ? item.body : item.html;
					} else {
						$('.mail_conter').html((item.html == '' ? item.body : item.html));
					}
				},
				yes: function (index, layers) {
					$('.domain_input:eq(2)').val(!_this.is_mail?item.to.replace(/(.*<|>)/g,''):item.from.replace(/(.*<|>)/g,''));
					$('[name="mail_to"]').val(_this.is_mail?item.to.replace(/(.*<|>)/g,''):item.from.replace(/(.*<|>)/g,''));
					$('[name="subject"]').val(!_this.is_mail?'Reply Mail [ '+item.subject +']':'');
					$('.tab-nav span:eq(6)').click();
					CKEDITOR.instances.editor1.setData('');
					layer.close(index);
				}
			})
		},

		// 获取编辑代码视图-方法
		open_editCode_view:function(obj,callback){
			var _this = this;
			var loadT = layer.open({
				type: 1,
				shift: 5,
				closeBtn: 2,
				area: "800px",
				title: "Edit title [" + obj.title + "]",
				content: '<form class="bt-form pd20 pb70">\
							<div class="line">\
								<p style="color:red;margin-bottom:10px">Tips：Ctrl+F Search keyword，Ctrl+G Find next，Ctrl+S Save，Ctrl+Shift+R Find & Replace!\
									<select class="bt-input-text" name="encoding" style="width: 74px;position: absolute;top: 20px;right: 19px;height: 22px;z-index: 9999;border-radius: 0;"></select>\
								</p>\
								<div style="max-height: 550px;min-height: 300px;overflow-y: auto; border:1px solid #ececec">\
									<textarea class="mCustomScrollbar bt-input-text" id="textBody" style="width:100%;margin:0 auto;line-height: 1.8;position: relative;top: 10px;" value="" />\
								</div>\
							</div>\
							<div class="bt-form-submit-btn" style="position:absolute; bottom:0; width:100%">\
								<button type="button" class="btn btn-danger btn-sm btn-editor-close">Close</button>\
								<button id="OnlineEditFileBtn" type="button" class="btn btn-success btn-sm">Save</button>\
							</div>\
						</form>',
				success:function(layers,index){
					var codeMirror = ''
					_this.get_config({service:obj.service},function(res){
						var u = ["utf-8", "GBK", "GB2312", "BIG5"],n = "",m = "";
						for(var p = 0; p < u.length; p++) {
							m = res.encoding == u[p] ? "selected" : "";
							n += '<option value="' + u[p] + '" ' + m + ">" + u[p] + "</option>"
						}
						$('[name="encoding"]').html(n);
						$('#textBody').val(res.data);
						codeMirror =  CodeMirror.fromTextArea(document.getElementById("textBody"), {
							extraKeys: {
								"Ctrl-F": "findPersistent",
								"Ctrl-H": "replaceAll",
								"Ctrl-S": function(e) {
									$("#textBody").text(codeMirror.getValue());
									_this.save_config({ service:obj.service, data:codeMirror.getValue()},function(res){
										layer.msg(res.msg,{icon:1});
									})
								}
							},
							mode:'text/x-nginx-conf',
							lineNumbers: true,
							matchBrackets: true,
							matchtags: true,
							autoMatchParens: true
						});
						codeMirror.focus();
					});
					$('.btn-editor-close').click(function(){
						layer.close(index);
					});
					$('#OnlineEditFileBtn').click(function(){
						var encoding = $('[name="encoding"]').val();
						_this.save_config({ service:obj.service, data: codeMirror.getValue()},function(res){
							layer.msg(res.msg,{icon:1});
						})
					});
				}
			});
		},
		//设置备份计划参数
		get_backup_task_set: function (setting) {
			var _this = this;
			$('.mail_backup_set #cycle').find("b").text(setting.type == 'week' ? 'Weekly' : 'Daily').attr("val", setting
				.type);
			$(".mail_backup_set .plan_hms [name='hour']").val(setting.where_hour);
			$(".mail_backup_set .plan_hms [name='minute']").val(setting.where_minute);
		},

		// 垃圾邮件恢复_方法
		move_out_junk: function (path,username) {
			var _this = this;
			this.send({
				tips: 'Restoring spam, please wait...',
				method: 'move_out_junk',
				data: {
					path: path,
					username: username
				},
				success: function (res) {
					_this.junk_mail_list();
					layer.msg(res.msg, { icon: res.status ? 1 : 2 });
				}
			});
		},
		// 标记为垃圾邮件_方法
		set_junk_mail: function (path,username) {
			var _this = this;
			layer.confirm('Are you sure you want to mark this message as spam?', {icon: 0,closeBtn: 2,title: 'Mark spam'}, function (index) {
				_this.send({
					tips: 'Marking as spam, please wait...',
					method: 'move_to_junk',
					data: {
						path: path,
						username: username
					},
					success: function (res) {
						_this.create_mail_list({p: 1});
						layer.msg(res.msg, { icon: res.status ? 1 : 2 });
					}
				});
			});
		},
		//刷新域名记录
        flush_domain_record: function(obj,callback){
            var _this = this;
            this.send({
				tips: obj == 'all'?'Refresh all domain records, it will take some time, please wait....':'Refresh domain record, please wait...',
				method: 'flush_domain_record',
				data: {
					domain: obj
				},
				success: function (res) {
				    if(res.status) _this.create_domain_list();
					if (callback) callback(res);
				}
			});
        },
		// 删除邮件_方法
		del_mail_view: function (index) {
			var item = this.mail_list[index],
				path = item.path,
				_this = this;
			this.send({
				tips: 'Deleting message, please wait...',
				method: 'delete_mail',
				data: {
					path: path
				},
				success: function (res) {
					if (!_this.is_mail) {
						_this.create_mail_list({
							p: 1
						}, function () {
							layer.msg(res.msg, {
								icon: 1
							});
						});
					} else {
						_this.create_sent_mail_list({
							p: 1
						}, function () {
							layer.msg(res.msg, {
								icon: 1
							});
						});
					}

				}
			});
		},
		//获取备份设置参数
		get_backup_task_status: function (callback) {
			this.send({
				tips: 'Getting backup settings parameters, please wait...',
				method: 'get_backup_task_status',
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		//保存备份设置
		open_backup_task: function (obj,callback) {
			this.send({
				tips: 'Saving backup settings parameters, please wait...',
				data: obj,
				method: 'open_backup_task',
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		//获取备份邮件列表
		get_backup_file_list: function (obj,callback) {
			this.send({
				tips: 'Getting backup file list, please wait...',
				method: 'get_backup_file_list',
				data: obj,
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		//获取已安装云存储插件列表
		get_cloud_storage_list: function (callback) {
			this.send({
				tips: 'Getting list of installed cloud storage plugins, please wait...',
				method: 'get_cloud_storage_list',
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		//关闭备份计划
		close_backup_task: function (callback) {
			this.send({
				tips: 'Closing backup settings, please wait...',
				method: 'close_backup_task',
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		//恢复上传备份邮件
		restore_backup_list: function (obj, callback) {
			this.send({
				tips: 'Restoring backup mails, please wait...',
				method: 'restore',
				data: {file_path:obj},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		//删除上传备份邮件
		delete_backup_list: function (obj, callback) {
			this.send({
				tips: 'Deleting backup mails, please wait...',
				url: '/files?action=DeleteFile',
				data: {path:obj},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 删除邮件_方法
		del_mail_view: function(index) {
			var item = this.mail_list[index],path = item.path,_this = this;
			this.send({
				tips: 'Deleting email, please wait...',
				method: 'delete_mail',
				data: {path:path},
				success: function (res) {
					if(_this.is_mail){
						_this.create_mail_list({p:1},function(){
							layer.msg(res.msg,{icon:1});
						});
					}else{
						_this.create_sent_mail_list({p:1},function(){
							layer.msg(res.msg,{icon:1});
						});
					}

				}
			});
		},

		//删除max记录和txt记录-请求
		delete_mx_txt_cache:function(obj,callback){
        	this.send({
				tips: 'Clearing MAX record and TXT record cache, please wait...',
				method: 'delete_mx_txt_cache',
				data:{domain:obj.domain},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},

		// 获取邮箱服务是否正常_请求
		check_mail_sys:function(obj,callback){
			this.send({
				tips: obj.tips,
				method: 'check_mail_sys',
				data:{hostname:obj.hostname},
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			})

		},
		//catchall开关
        enable_catchall:function(obj,callback){
			this.send({
				tips: 'Setting catchall, please wait...',
				method: 'enable_catchall',
				data:{domain:obj.domain,email:obj.email},
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			})

		},
		// 获取邮件列表_请求
		get_mail_list: function (obj, callback) {
			var _this = this, _form = {};
			this.send({
				tips: 'Getting a list of mailboxes, please wait...',
				method: 'get_mails',
				data: obj,
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},

		// 获取垃圾邮件列表_请求
		get_junk_mails: function (obj, callback) {
			var _this = this;
			this.send({
				tips: 'Retrieving the spam mailbox list, please wait...',
				method: 'get_junk_mails',
				data: obj,
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},

		// 获取发件箱列表_请求
		get_sent_mails:function(obj,callback){
			this.send({
				tips:'Getting a list of outboxes, please wait...',
				method:'get_sent_mails',
				data:obj,
				check:true,
				success:function(res){
					if(callback) callback(res)
				}
			});
		},

		// 获取服务配置文件_请求
		get_config:function(obj,callback){
			this.send({
				tips:'Getting service profile, please wait...',
				method:'get_config',
				data:obj,
				success:function(res){
					if(callback) callback(res)
				}
			})
		},

		// 保存服务配置文件_请求
		save_config:function(obj,callback){
			this.send({
				tips:'Saving service profile, please wait...',
				method:'save_config',
				data:obj,
				success:function(res){
					if(callback) callback(res);
				}
			})
		},

		// 获取smtp设置
		get_smtp_status:function(callback){
			this.send({
				tips:'Getting SMTP profile, please wait...',
				check: true,
				method:'get_smtp_status',
				success:function(res){
					if(callback) callback(res);
				}
			})
		},

		// 保存smtp设置
		set_smtp_relay:function(obj,callback){
			this.send({
				tips:'Saving SMTP profile, please wait...',
				method:'set_smtp_relay',
				data:obj,
				success:function(res){
					if(callback) callback(res);
				}
			})
		},

		// 取消smtp设置
		cancel_smtp_relay:function(callback){
			this.send({
				tips:'Canceling SMTP profile, please wait...',
				method:'cancel_smtp_relay',
				success:function(res){
					if(callback) callback(res);
				}
			})
		},

		// 设置密抄邮箱
		set_mail_bcc(obj,callback){
			this.send({
				tips:'Setting BCC service, please wait...',
				method: 'set_mail_bcc',
				data: obj,
				success: function(res){
					if (callback) callback(res);
				}
			})
		},

		// 获取密抄邮箱列表
		get_bcc:function(callback){
			this.send({
				tips:'Getting BCC service, please wait...',
				method: 'get_bcc',
				success: function(res){
					if (callback) callback(res);
				}
			})
		},

		// 删除密抄邮箱信息
		del_bcc:function(obj,callback){
			this.send({
				tips: 'Deleting BCC setting, please wait...',
				method: 'del_bcc',
				data: obj,
				success: function(res){
					if (callback) callback(res);
				}
			})
		},

		// 获取邮箱用户列表_请求
		get_mailboxs_list: function (obj, callback) {
			this.send({
				tips: 'Getting a list of mailbox users, please wait...',
				method: 'get_mailboxs',
				data: {
					domain: obj.domain || '',
					p: obj.p || 1,
					size: obj.size || 10
				},
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			});
		},
		// 获取所有邮箱用户列表
		get_all_user:function(callback){
			var _this = this;
			if(!_this.is_update){
				if (callback) callback(_this.mail_user_list);
				return false;
			}
			this.send({
				tips: 'Getting a list of mailbox users, please wait...',
				method: 'get_all_user',
				check: true,
				success: function (res) {
					if (res.length == 0) {
						layer.msg('Email address is empty, please add user email', {icon: 2});
						return false;
					}
					_this.mail_user_list = res, one_mail =  _this.mail_user_list[0].username;
				    var html = '',_input = $('.select_conter input');
			      	for(var i=0;i<_this.mail_user_list.length;i++){
    			        var item = _this.mail_user_list[i];
    			        html += '<li>'+ item.username +'</li>'
    			    }
    			    _input.next().html(html);
    			    _input.prev().html(one_mail);
    			    _input.val(one_mail);
    			    _input.eq(2).val('');
					if (callback) callback(res);
					_this.is_update = false;
				}
			});
		},
		// 提交ssl证书
		set_ssl_certificate:function(obj,callback){
			this.send({
				tips:'Opening ssl service, please wait...',
				method: 'set_ssl',
				data: {key: obj.keyValue,csr: obj.csrValue,act:obj.act},
				success: function(res){
					if (callback) callback(res);
				}
			})
		},
		// 添加邮箱用户_请求
		add_mailboxs: function (obj, callback) {
			this.send({
				tips: 'Adding mailbox users, please wait...',
				method: 'add_mailbox',
				data: {
					quota: obj.quota,
					username: obj.username,
					password: obj.password,
					quote: obj.quote,
					full_name: obj.full_name,
					department: obj.department,
					position: obj.position,
					phone: obj.phone,
					sex: obj.sex,
					is_admin: obj.is_admin
				},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},

		// 删除邮箱用户列表_请求
		del_mailboxs: function (obj, callback) {
			this.send({
				tips: 'Deleting mailbox users, please wait...',
				method: 'delete_mailbox',
				data: { username: obj.username },
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},

		// 编辑邮箱用户_请求
		updatae_mailboxs: function (obj, callback) {
			this.send({
				tips: 'Editing mailbox users, please wait...',
				method: 'update_mailbox',
				data: {
					quota: obj.quota,
					username: obj.username,
					password: obj.password,
					quote: obj.quote,
					full_name: obj.full_name,
					department: obj.department,
					position: obj.position,
					phone: obj.phone,
					sex: obj.sex,
					active: obj.active,
					is_admin: obj.is_admin
				},
				success: function (res) {
					if (callback) callback(res);
				}
			});
		},

		// 添加域名_请求
		add_domain: function (obj, callback) {
			this.send({
				tips: 'Adding domain name, please wait...',
				method: 'add_domain',
				data: {
					domain: obj.domain,
					a_record:obj.a_record,
					company_name: obj.company_name,
					admin_name: obj.admin_name,
					admin_phone: obj.admin_phone
				},
				success: function (res) {
					if (callback) callback(res);
				}
			});
		},

		// 删除域名_请求
		del_domain: function (obj, callback) {
			this.send({
				tips: 'Deleting domain name, please wait...',
				method: 'delete_domain',
				data: {
					domain: obj.domain
				},
				success: function (res) {
					if (callback) callback(res);
				}
			});
		},

		// 修改域名信息_请求
		update_domain: function (obj, callback) {
			this.send({
				tips: 'Modifying domain name data, please wait...',
				method: 'update_domain',
				data: {
					active: obj.active,
					domain: obj.domain,
					company_name: obj.company_name,
					admin_name: obj.admin_name,
					admin_phone: obj.admin_phone
				},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},

		// 获取域名列表_请求
		get_domain_list: function (obj, callback) {
			this.send({
				tips: 'Verifying domain name MX records and TXT records, please wait....',
				method: 'get_domains',
				data: { p: obj.page, size: obj.size },
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 获取域名列表的证书状态
		get_certificate_status: function (site, callback) {
			this.send({
				tips: 'Getting certificate status...',
				method: 'get_multiple_certificate',
				data: { domain: site },
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 设置域名列表的证书状态
		set_mail_certificate_multiple: function (obj, callback) {
			this.send({
				tips: 'Setting certificate status...',
				method: 'set_mail_certificate_multiple',
				data: obj,
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 获取邮局证书状态
		get_mailSSL_status: function(callback){
			this.send({
				tips: 'Getting ssl status...',
				method: 'get_ssl_status',
				check: true,
				success:function(res){
					if(callback) callback(res);
				}
			})
		},
		// 设置邮件保留天数
		set_save_day: function (obj, callback) {
			this.send({
				tips: 'Setting mail retention time...',
				method: 'set_save_day',
				data: {
					save_day: obj
				},
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},

		// 获取邮件保留天数
		get_save_day: function (callback) {
			this.send({
				tips: 'Getting mail retention time...',
				method: 'get_save_day',
				check: true,
				success: function (res) {
					if (callback) callback(res);
				}
			})
		},
		// 获取反垃圾邮件状态
		get_anti_spam_status: function(callback){
			this.send({
				tips: 'Getting anti spam status...',
				method: 'get_anti_spam_status',
				check: true,
				success:function(res){
					if(callback) callback(res);
				}
			})
		},
		// 发送邮件_请求
		send_mail_conter: function (obj, callback) {
			this.send({
				tips: 'Sending mail, please wait...',
				method: 'send_mail',
				data: {
					smtp_server: obj.smtp_server || 'localhost',
					mail_from: obj.mail_from,
					password: obj.password,
					mail_to: obj.mail_to,
					subject: obj.subject,
					content: obj.content,
					subtype: obj.subtype || 'plain'
				},
				success: function (res) {
					if (callback) callback(res)
				}
			});
		},

		// 登录邮箱界面_请求
		login_mail_stuats: function (obj, callback) {
			this.send({
				tips: 'Verifying the email account, please wait...',
				method: 'login',
				data: {
					username: obj.username,
					password: obj.password,
					smtp_server: obj.smtp_server,
					protocol: obj.protocol,
					imap_server: obj.imap_server,
					pop_server: obj.pop_server
				},
				success: function (res) {
					if (callback) callback(res);
					bt.set_cookie('mail_login', JSON.stringify(res.data));
				}
			});
		},

		// 获取服务状态_请求
		get_service_status: function(callback){
			this.send({
				tips:'Getting Mail service status, please wait...',
				method:'get_service_status',
				success:function(res){
					if(callback) callback(res);
				}
			})
		},

		// 获取列表
		get_list: function(callback){
			this.send({
				tips:'Getting forwarding, please wait...',
				method:'get_mail_forward',
				success:function(res){
					if(callback) callback(res);
				}
			})
		},

		// 添加转发邮件
		set_mail_forward: function(obj,callback){
			this.send({
				tips:'Getting forwarding, please wait...',
				method:'set_mail_forward',
				data: obj,
				success:function(res){
					if(callback) callback(res);
				}
			})
		},

		// 编辑转发邮件
		edit_mail_forward: function(obj,callback){
			this.send({
				tips:'Editting forwarding, please wait...',
				method:'edit_mail_forward',
				data: obj,
				success:function(res){
					if(callback) callback(res);
				}
			})
		},

		// 删除转发邮件
		delete_mail_forward: function(obj,callback){
			this.send({
				tips:'Deleting forward, please wait...',
				method:'delete_mail_forward',
				data: obj,
				success:function(res){
					if(callback) callback(res);
				}
			})
		},

		// 获取日志列表_请求
		get_logs_list:function(callback){
			this.send({
				tips:'Getting log list, please wait...',
				method:'get_mail_log',
				success:function(res){
					if(callback) callback(res);
				}
			})
		},

		// HTML转义方法-方法
		htmlEscape: function (text) {
			return text.replace(/[<>"&]/g, function (match, pos, originalText) {
				switch (match) {
					case "<": return "&lt;";
					case ">": return "&gt;";
					case "&": return "&amp;";
					case "\"": return "&quot;";
				}
			});
		},

		// 表格动态滚动条（元素选择器）—方法
		tableAutoWidth:function(el,length){
			var _table = $(el);
			if(_table.parent().prev('table').length == 0){
				var th_list = _table.find('thead tr th'),_arry = [],_th_list = '';
				th_list.each(function(item,index){
					var clientWidth = parseInt($(this)[0].clientWidth);
					_th_list += '<th width="'+ clientWidth +'">'+ $(this).html() +'</th>';
				});
				_table.parent().before('<table class="table table-hover"><thead><tr>'+ _th_list +($(el).find('tr').length  > length+1?'<th width="12" style="padding:0;"></th>':'')+'</tr></thead></table>');
				_table.css('marginTop','-35px');
			}
			// _table.appendTo('<div style="width: 100%;height:15px;position: absolute;bottom: 10px;background: -webkit-linear-gradient(top,rgba(255, 255, 255, 0),rgba(241, 241, 241, 0.8));"></div>')
		},

		// 表格自动适应宽度（选择器，百分比）-方法
		table_auto_width:function(el,ratio){
			var width = $('.layui-layer-page').width();
			$('#mails_list '+el).width( parseInt(width * parseFloat(ratio)));
		},

		// 动态加载脚本(路径，回调)—方法
		loadScript:function(src, callback){
			var script = document.createElement('script'),
				head = document.getElementsByTagName('head')[0];
			script.type = 'text/javascript';
			script.charset = 'UTF-8';
			script.src = src;
			if (script.addEventListener) {
				script.addEventListener('load', function () {
				callback();
				}, false);
			} else if (script.attachEvent) {
				script.attachEvent('onreadystatechange', function () {
				var target = window.event.srcElement;
				if (target.readyState == 'loaded') {
					callback();
				}
				});
			}
			head.appendChild(script);
		},

		// 请求封装模块
		send: function (obj) {
			var loadT = '';
			if (obj.load == undefined) obj.load = 0;
			if (obj.url == undefined) {
				if (obj.plugin_name === undefined && this.plugin_name !== undefined) obj.plugin_name = this.plugin_name
				if (!obj.plugin_name || !obj.method) {
					layer.msg('The plugin class name, or plugin method name is missing!', {
						icon: 2
					});
					return false;
				}
			}
			if (!obj.check && (obj.load === 0 || obj.tips != '')) {
				loadT = layer.msg(obj.tips, {
					icon: 16,
					time: 0,
					shade: 0.3
				});
			} else if (obj.load === 1 || (obj.tips == undefined && obj.load == undefined)) {
				loadT = layer.load();
			}
			$.ajax({
				type: 'POST',
				url: obj.url != undefined ? obj.url : ('/plugin?action=a&name=' + obj.plugin_name + '&s=' + obj.method),
				data: obj.data || {},
				timeout: obj.timeout || 99999999,
				complete: function (res) {
					if (obj.load === 0 || obj.load === 1) layer.close(loadT);
				},
				success: function (rdata) {
					if (obj.check) {
						obj.success(rdata);
						return false
					}
					if (rdata.status === false) {
						layer.msg(rdata.msg, { icon: 2 });
						return false;
					}
					obj.success(rdata);
				},
				error: function (ex) {
					if (!obj.error) {
						obj.msg || obj.msg == undefined ? layer.msg("Request error", {
							icon: 2
						}) : '';
						return;
					}
					return obj.error(ex);
				}
			});
		}
	}
	mail.init();
</script>
